
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Building your own Venmo with Stellar</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-32360357-1', 'auto');
      ga('send', 'pageview');
      $(document).ready(function() {
        $('.toc-link').on('click', function(){
          ga('send', 'pageview', {
            page: location.pathname + location.search  + location.hash
          });
        });
      });
    </script>
    <style>
    .remotehqad{
      background-color: #F3F7F9 !important;
      border: 4px solid #2E3336 !important;
    }
    </style>
  </head>

  <body class="index" data-languages="[&quot;javascript&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo.png" class="logo" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="javascript">javascript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc" class="toc-list-h1">
          <li>
            <a href="#building-your-own-venmo-with-stellar" class="toc-h1 toc-link" data-title="building-your-own-venmo-with-stellar">Building your own Venmo with Stellar</a>
          </li>
          <li>
            <a href="#concepts" class="toc-h1 toc-link" data-title="concepts">Concepts</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#stellar-consensus-protocol" class="toc-h2 toc-link" data-title="stellar-consensus-protocol">Stellar Consensus Protocol</a>
                  </li>
                  <li>
                    <a href="#stellar-development-foundation" class="toc-h2 toc-link" data-title="stellar-development-foundation">Stellar Development Foundation</a>
                  </li>
                  <li>
                    <a href="#stellar-core-and-horizon-api" class="toc-h2 toc-link" data-title="stellar-core-and-horizon-api">Stellar Core and Horizon API</a>
                  </li>
                  <li>
                    <a href="#account" class="toc-h2 toc-link" data-title="account">Account</a>
                  </li>
                  <li>
                    <a href="#assets" class="toc-h2 toc-link" data-title="assets">Assets</a>
                  </li>
                  <li>
                    <a href="#anchor" class="toc-h2 toc-link" data-title="anchor">Anchor</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#mapping-venmo-to-stellar" class="toc-h1 toc-link" data-title="mapping-venmo-to-stellar">Mapping Venmo to Stellar</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#download-the-app-and-create-an-user" class="toc-h2 toc-link" data-title="download-the-app-and-create-an-user">Download the app and create an user</a>
                  </li>
                  <li>
                    <a href="#account-verification" class="toc-h2 toc-link" data-title="account-verification">Account verification</a>
                  </li>
                  <li>
                    <a href="#credit-from-bank-account" class="toc-h2 toc-link" data-title="credit-from-bank-account">Credit from bank account</a>
                  </li>
                  <li>
                    <a href="#p2p-payments" class="toc-h2 toc-link" data-title="p2p-payments">P2P payments</a>
                  </li>
                  <li>
                    <a href="#transfer-balance-from-anchorx-to-bank-account" class="toc-h2 toc-link" data-title="transfer-balance-from-anchorx-to-bank-account">Transfer balance from AnchorX to Bank account</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#building-the-backend" class="toc-h1 toc-link" data-title="building-the-backend">Building the backend</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#setting-up-the-server" class="toc-h2 toc-link" data-title="setting-up-the-server">Setting up the server</a>
                  </li>
                  <li>
                    <a href="#user-model" class="toc-h2 toc-link" data-title="user-model">User model</a>
                  </li>
                  <li>
                    <a href="#user-signup-mutation" class="toc-h2 toc-link" data-title="user-signup-mutation">User signup mutation</a>
                  </li>
                  <li>
                    <a href="#assigning-a-stellar-account-to-new-users" class="toc-h2 toc-link" data-title="assigning-a-stellar-account-to-new-users">Assigning a Stellar account to new users</a>
                  </li>
                  <li>
                    <a href="#encrypting-the-seed" class="toc-h2 toc-link" data-title="encrypting-the-seed">Encrypting the seed</a>
                  </li>
                  <li>
                    <a href="#testing" class="toc-h2 toc-link" data-title="testing">Testing</a>
                  </li>
                  <li>
                    <a href="#creating-the-account-in-the-stellar-ledger" class="toc-h2 toc-link" data-title="creating-the-account-in-the-stellar-ledger">Creating the account in the Stellar ledger</a>
                  </li>
                  <li>
                    <a href="#payments" class="toc-h2 toc-link" data-title="payments">Payments</a>
                  </li>
                  <li>
                    <a href="#issuing-anchorx-custom-asset" class="toc-h2 toc-link" data-title="issuing-anchorx-custom-asset">Issuing AnchorX custom asset</a>
                  </li>
                  <li>
                    <a href="#setting-up-issuing-account" class="toc-h2 toc-link" data-title="setting-up-issuing-account">Setting up issuing account</a>
                  </li>
                  <li>
                    <a href="#creating-a-trustline" class="toc-h2 toc-link" data-title="creating-a-trustline">Creating a trustline</a>
                  </li>
                  <li>
                    <a href="#allow-trustline" class="toc-h2 toc-link" data-title="allow-trustline">Allow trustline</a>
                  </li>
                  <li>
                    <a href="#welcome-balance" class="toc-h2 toc-link" data-title="welcome-balance">Welcome balance</a>
                  </li>
                  <li>
                    <a href="#paying-with-usd" class="toc-h2 toc-link" data-title="paying-with-usd">Paying with USD</a>
                  </li>
                  <li>
                    <a href="#credit-account" class="toc-h2 toc-link" data-title="credit-account">Credit account</a>
                  </li>
                  <li>
                    <a href="#debit-account" class="toc-h2 toc-link" data-title="debit-account">Debit account</a>
                  </li>
                  <li>
                    <a href="#conclusion" class="toc-h2 toc-link" data-title="conclusion">Conclusion</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#building-the-mobile-wallet" class="toc-h1 toc-link" data-title="building-the-mobile-wallet">Building the mobile wallet</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#mobile-wallet-boilerplate" class="toc-h2 toc-link" data-title="mobile-wallet-boilerplate">Mobile wallet boilerplate</a>
                  </li>
                  <li>
                    <a href="#using-the-stellar-sdk-in-react-native" class="toc-h2 toc-link" data-title="using-the-stellar-sdk-in-react-native">Using the Stellar-SDK in React Native</a>
                  </li>
                  <li>
                    <a href="#balance-updates" class="toc-h2 toc-link" data-title="balance-updates">Balance updates</a>
                  </li>
                  <li>
                    <a href="#using-streaming-mode" class="toc-h2 toc-link" data-title="using-streaming-mode">Using streaming mode</a>
                  </li>
                  <li>
                    <a href="#payment-component" class="toc-h2 toc-link" data-title="payment-component">Payment component</a>
                  </li>
                  <li>
                    <a href="#showing-payments" class="toc-h2 toc-link" data-title="showing-payments">Showing payments</a>
                  </li>
                  <li>
                    <a href="#depositing-and-withdrawing-fiat-from-the-wallet" class="toc-h2 toc-link" data-title="depositing-and-withdrawing-fiat-from-the-wallet">Depositing and withdrawing fiat from the wallet</a>
                  </li>
                  <li>
                    <a href="#deposits" class="toc-h2 toc-link" data-title="deposits">Deposits</a>
                  </li>
                  <li>
                    <a href="#withdrawals" class="toc-h2 toc-link" data-title="withdrawals">Withdrawals</a>
                  </li>
                  <li>
                    <a href="#sending-payments" class="toc-h2 toc-link" data-title="sending-payments">Sending payments</a>
                  </li>
                  <li>
                    <a href="#new-payment-form" class="toc-h2 toc-link" data-title="new-payment-form">New Payment form</a>
                  </li>
                  <li>
                    <a href="#new-payment-container" class="toc-h2 toc-link" data-title="new-payment-container">New Payment container</a>
                  </li>
                  <li>
                    <a href="#conclusion-2" class="toc-h2 toc-link" data-title="conclusion">Conclusion</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#best-practices" class="toc-h1 toc-link" data-title="best-practices">Best practices</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#using-multisignature" class="toc-h2 toc-link" data-title="using-multisignature">Using multisignature</a>
                  </li>
                  <li>
                    <a href="#adding-signers-to-an-account" class="toc-h2 toc-link" data-title="adding-signers-to-an-account">Adding signers to an account</a>
                  </li>
                  <li>
                    <a href="#managing-the-issuing-account" class="toc-h2 toc-link" data-title="managing-the-issuing-account">Managing the issuing account</a>
                  </li>
                  <li>
                    <a href="#stellar-core-and-horizon" class="toc-h2 toc-link" data-title="stellar-core-and-horizon">Stellar Core and Horizon</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#conclusion-3" class="toc-h1 toc-link" data-title="conclusion">Conclusion</a>
          </li>
      </div>
        <ul class="toc-footer">
            <li><a href='https://twitter.com/abuiles'>Follow me on Twitter @abuiles</a></li>
            <li><a href='https://github.com/abuiles/building-your-own-venmo-with-stellar/issues'>Report issues</a></li>
            <li><a href='https://github.com/lord/slate'>Documentation Powered by Slate</a></li>
        </ul>
        <script async="" type="text/javascript" src="https://blog.abuiles.com/assets/js/remotehqads.js" id="_remotehqads_js"></script>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='building-your-own-venmo-with-stellar'>Building your own Venmo with Stellar</h1>
<p>Stellar is a distributed ledger technology which allows anyone to build low-cost and fast financial services. This tutorial will walk you through some of its features and show you how to create a Venmo clone on top of Stellar called <code>AnchorX</code>.</p>

<p>In order to maintain customer accounts, Stellar requires you to create some sort of organization. Think about it as a &quot;Stellar company&quot; but in Stellar jargon, that is called an <code>anchor</code>. There are 2 ways to do this. Either you create Stellar accounts on behalf of customers or use the memo field of the transaction to operate on behalf of your customers/users.</p>

<p>The <a href="https://www.stellar.org/developers/guides/anchor/index.html#customer-accounts">official documentation</a> covers the second method but there is no documentation about the first one.</p>

<p>This tutorial will show you how to create an anchor maintaining a Stellar account for each customer, hiding the implementation details. It will use the programming language JavaScript and the mobile wallet will be written using React Native.</p>
<h1 id='concepts'>Concepts</h1><h2 id='stellar-consensus-protocol'>Stellar Consensus Protocol</h2>
<p>Stellar is built on top of the Stellar Consensus Protocol (SCP), which defines a way to reach consensus without relying on close
systems, this is what helps maintaining the Stellar ledger. Explaining how the protocol works is beyond the scope of this tutorial, but you can learn more about <a href="https://www.stellar.org/developers/guides/concepts/scp.html">here</a></p>
<h2 id='stellar-development-foundation'>Stellar Development Foundation</h2>
<p>The Stellar Development Foundation (SDF) is a non-profit corporation which develops and maintains the Stellar Network and the Stellar Protocol. You can learn more about them in the <a href="https://www.stellar.org/about/mandate/">mandate page</a></p>
<h2 id='stellar-core-and-horizon-api'>Stellar Core and Horizon API</h2>
<p>The <code>Stellar Core</code> software is in charge of communicating and maintaining the Stellar network. Using the Stellar Consensus Protocol (SCP), it does validation and agrees on the status of transactions in the network. Anyone can run the software. Running Stellar Core is similar to running an Ethereum or Bitcoin node, except that there is no mining involved.</p>

<p><code>Horizon</code> is a RESTful API which allows you to interact with <code>Stellar Core</code> and makes it easy to build applications using the network. With it you can submit transactions, read accounts or subscribe to events in the network.</p>

<p>You can interact with it using any HTTP client like cURL, Postman or Paw. There are also SDKs for different programming languages like Go, Java, JavaScript, Ruby, etc.</p>

<p>Setting up <code>Stellar Core</code> or <code>Horizon</code> won&#39;t be included here but you can learn about it in the <a href="https://www.stellar.org/developers/guides/get-started/">official guides</a>.</p>

<p>For this tutorial you will be using a test network (testnet) run by the SDF under https://horizon-testnet.stellar.org/ and the JavaScript Stellar SDK.</p>
<h2 id='account'>Account</h2>
<p>The most important unit in Stellar are the accounts. You need to
create one before interacting with the network. To create an account
you need to deposit Lumens into it, you can get the Lumens buying them
in a exchange or asking a friend for some.</p>

<p>When you create an account, you get a public and private key. The
public key is the equivalent of your bank account number and then the
private key is the password. The private key is required to sign each
transaction.</p>
<h3 id='creating-accounts-in-the-test-network'>Creating accounts in the test network</h3>
<blockquote>
<p>For now, run the code below on repl.it <a href="https://repl.it/@abuiles/CreateStellarAccount">https://repl.it/@abuiles/CreateStellarAccount</a></p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">StellarSdk</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'stellar-sdk'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-fetch'</span><span class="p">)</span>

<span class="c1">// Generates a keypair and funds account with friendbot</span>
<span class="nx">async</span> <span class="kd">function</span> <span class="nx">createAccount</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">pair</span> <span class="o">=</span> <span class="nx">StellarSdk</span><span class="p">.</span><span class="nx">Keypair</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Requesting Lumens'</span><span class="p">)</span>

  <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s2">`https://horizon-testnet.stellar.org/friendbot?addr=</span><span class="p">${</span><span class="nx">pair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">pair</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">pair</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">createAccount</span><span class="p">()</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`
    Congrats, you have a Stellar account in the test network!
    seed: </span><span class="p">${</span><span class="nx">pair</span><span class="p">.</span><span class="nx">secret</span><span class="p">()}</span><span class="s2">
    id: </span><span class="p">${</span><span class="nx">pair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">()}</span><span class="s2">
  `</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`https://horizon-testnet.stellar.org/accounts/</span><span class="p">${</span><span class="nx">pair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">()}</span><span class="s2">`</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`
    Loading account from test network:
    </span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">
  `</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span>
<span class="p">}</span>

<span class="nx">run</span><span class="p">()</span>

<span class="cm">/* Example output

   Congrats, you have a Stellar account in the test network!
   seed: SCUNXTHOURNM4W4HIUQ7GZIQ25VHD4UPRWWCCX6LY24EZXMGGNVBJVST
   id: GBWR2HBRWPINWB5VEAXXV5QUHRCT7HC7P635UCZPX3MGGCGQRIKDL4R6


   Loading account from test network:
   https://horizon-testnet.stellar.org/accounts/GBWR2HBRWPINWB5VEAXXV5QUHRCT7HC7P635UCZPX3MGGCGQRIKDL4R6
*/</span>
</code></pre>
<p>On the right you can see how to generate a <code>keypair</code> with the <code>Stellar JS SDK</code> and
then ask a service run by the Stellar Development Foundation called <code>friendbot</code> to
give us some initial Lumens.</p>
<h2 id='assets'>Assets</h2><pre class="highlight json tab-json"><code><span class="err">//</span><span class="w"> </span><span class="err">https</span><span class="p">:</span><span class="err">//horizon.stellar.org/accounts/GBCFAMVYPJTXHVWRFP</span><span class="mi">7</span><span class="err">VO</span><span class="mi">6</span><span class="err">F</span><span class="mi">4</span><span class="err">QE</span><span class="mi">7</span><span class="err">B</span><span class="mi">4</span><span class="err">UHAVJOEG</span><span class="mi">5</span><span class="err">VR</span><span class="mi">6</span><span class="err">VEB</span><span class="mi">5</span><span class="err">M</span><span class="mi">67</span><span class="err">GHQGEEAB</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GBCFAMVYPJTXHVWRFP7VO6F4QE7B4UHAVJOEG5VR6VEB5M67GHQGEEAB"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"account_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GBCFAMVYPJTXHVWRFP7VO6F4QE7B4UHAVJOEG5VR6VEB5M67GHQGEEAB"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"balances"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"balance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0000000"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"limit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"922337203685.4775807"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"credit_alphanum4"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EURT"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_issuer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GAP5LETOV6YIE62YAM56STDANPRDO7ZFDBGSNHJQIYGGKSMOZAHOOS2S"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"balance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0000000"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"limit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"922337203685.4775807"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"credit_alphanum4"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ETH"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_issuer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GBDEVU63Y6NTHJQQZIKVTC23NWLQVP3WJ2RI2OTSJTNYOIGICST6DUXR"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"balance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0000000"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"limit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"922337203685.4775807"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"credit_alphanum4"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"USD"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_issuer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GBSTRH4QOTWNSVA6E4HFERETX4ZLSR3CIUBLK7AXYII277PFJC4BBYOG"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"balance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"57.9899400"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"native"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Assets are resources with economic value like money, equity, real
estate, goats, you name it. Cryptocurrencies allow you to represent
any kind of asset. Stellar is no exception, it allows any account to
define traditional assets or even come up with new exciting
assets. These can be easily traded and exchanged over the Stellar
network.</p>

<p>Under the blankets, Stellar uses a native asset which is called the Lumen represented with the symbol XLM.</p>

<p>Assets still feel a bit abstract. On the right you can find a concrete example of how an account balance could look like in JSON format.</p>

<p>It contains the following assets:</p>

<ul>
<li>EURT: Asset issued by <a href="http://tempo.eu.com/">Tempo</a> a remittances company.</li>
<li>ETH: This asset represents Ether, you send real <code>ETH</code> to <a href="https://apay.io/">https://apay.io/</a> and they credit your Stellar account with their <code>ETH</code>.</li>
<li>USD: Asset representing <code>Dollars</code>, issued by <a href="https://stronghold.co/">Stronghold</a>.</li>
<li>native: Native asset of the network, it represents <code>Lumens</code>.</li>
</ul>

<p>You can learn more about assets in the SDF guides: <a href="https://www.stellar.org/developers/guides/concepts/assets.html">https://www.stellar.org/developers/guides/concepts/assets.html</a></p>
<h2 id='anchor'>Anchor</h2>
<p>At the beginning of this tutorial, you read that an entity like
Venmo is called an anchor.  Anchors issue assets on top of Stellar and
then credit those asset to other Stellar accounts. If the anchor
represents fiat, then it is likely an authorized entity to deal with
money like banks, savings and credit institutions or a
remittance company. User deposit fiat to the anchor&#39;s account and they
credit the user Stellar account with the equivalent balance.</p>

<p>This is how banks or Venmo works but instead of using a public ledger
like Stellar, they have their own private system and use third parties
like ACH or SWIFT to move money around.</p>

<p>Anchors can represent also other cryptocurrencies. <a href="https://apay.io/">Papaya</a> is an anchor which includes support for cryptocurrencies like <code>ETH</code>, <code>BTC</code> and others.</p>

<p>If you want to deposit Ether, they give you an Ethereum address. After you deposit Ether to that address they issue the equivalent to your Stellar account. In this case you&#39;ll have to trust Papaya because they&#39;ll be acting as custodian for the Ether you sent them.</p>

<p>In this tutorial, you will be creating an anchor which will issue an
asset representing USD. User will have to download an app, you&#39;ll fake a
KYC process and then create a Stellar account for the user and
authorize the user to hold the asset. Once the user have been
authorized they will be able to deposit USD or debit USD from their accounts.</p>

<p>You can learn more about anchors in the SDF guides: <a href="https://www.stellar.org/developers/guides/anchor/">https://www.stellar.org/developers/guides/anchor/</a></p>
<h1 id='mapping-venmo-to-stellar'>Mapping Venmo to Stellar</h1>
<p>The following is high level overview of what happens when you want to use Venmo:</p>

<ol>
<li>Download the app and create an user.</li>
<li>Go through phone number, email and bank account verification.</li>
<li>Once you are authorized to use Venmo, transfer money from your bank account and send it to other Venmo users.</li>
<li>Transfer to your bank whatever balance you have left.</li>
</ol>

<p>Let&#39;s translate the steps above to actions in AnchorX and then identify the requirements to setup the anchor.</p>
<h3 id='download-the-app-and-create-an-user'>Download the app and create an user</h3>
<p>Users should be able to download an app and then create an account. To
keep things the application will use username (no password) for
sign-up/sign-in.</p>
<h3 id='account-verification'>Account verification</h3>
<p>In Venmo there is a verification process, since this is a toy example
you won&#39;t be including that. By default every user will be marked as
verified. In real application, you probably want to collect user data
like SSN, driver&#39;s license, passport, proof of residence, etc.</p>
<h3 id='credit-from-bank-account'>Credit from bank account</h3>
<p>The app will have a section which will simulate transferring from your bank account.</p>
<h3 id='p2p-payments'>P2P payments</h3>
<p>Once the account has been provisioned and have some Dollars, users should be able to send money to other users.</p>
<h3 id='transfer-balance-from-anchorx-to-bank-account'>Transfer balance from AnchorX to Bank account</h3>
<p>The app will have a section for depositing their dollars to their bank account.</p>
<h1 id='building-the-backend'>Building the backend</h1>
<p>In this section, you&#39;ll be implementing a GraphQL API which will support user sign-up and sign-in, deposits, withdrawals and payments. The mobile application will be interacting with this API.</p>

<p>The server will be written in <code>TypeScript</code> and use <a href="https://www.prisma.io/">Prisma</a> to generate the user management API.</p>
<h2 id='setting-up-the-server'>Setting up the server</h2>
<p>In this section you can find a GraphQL server created with <a href="https://oss.prisma.io/content/graphql-cli/01-overview">GraphQL CLI</a> and using the <code>TypeScript</code> template. To make things easy there is boilerplate project which you can use to get started.</p>

<p>Download the boilerplate running the following commands:</p>

<ol>
<li><code>git clone https://github.com/abuiles/anchorx-api-boilerplate anchorx-api</code></li>
<li><code>cd anchorx-api</code></li>
</ol>

<p>Next you are going to add the user model.</p>
<h2 id='user-model'>User model</h2>
<p>The user model is defined in <code>database/datamodel.graphql</code>. Users in AnchorX signup using their username. After they signup, the service assigns automatically a Stellar account. The code on the right is the prisma representaion for the user model.</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">type</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="nl">id</span><span class="p">:</span> <span class="nx">ID</span><span class="o">!</span> <span class="p">@</span><span class="nd">unique</span>
  <span class="nx">username</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span> <span class="p">@</span><span class="nd">unique</span>
  <span class="nx">stellarAccount</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span>
  <span class="nx">stellarSeed</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span>
<span class="p">}</span>
</code></pre>
<p>After adding the user model definition to <code>database/datamodel.graphql</code>, you have to run <code>yarn prisma deploy</code> to create a new table in the database and get the CRUD end-points for users.</p>

<p>The <a href="https://github.com/abuiles/anchorx-api/pull/2">pull request #2</a>, shows the changes added in this step. The important changes are <a href="https://github.com/abuiles/anchorx-api/pull/2/files#diff-5ca8cc3ddf0d92dda0872ee778220e21">https://github.com/abuiles/anchorx-api/pull/2/files#diff-5ca8cc3ddf0d92dda0872ee778220e21</a>, the rest is code generated by prisma.</p>

<p>Next you need to add a GraphQL mutation to support user signup. After a new user is created, you need to provision a Stellar account. Provisioning a new account requires multiple steps:</p>

<ol>
<li>Create a public and private key pair.</li>
<li>After the public key has been created, fund that account with some Lumens.</li>
<li>After the account has been created in the Stellar ledger, create a trustline with the anchor asset.</li>
</ol>
<h2 id='user-signup-mutation'>User signup mutation</h2>
<blockquote>
<p>Edit src/schema.graphql to define the schema</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="err">#</span> <span class="kr">import</span> <span class="nx">User</span> <span class="nx">from</span> <span class="s1">'./generated/prisma.graphql'</span>

<span class="nx">type</span> <span class="nx">Query</span> <span class="p">{</span>
  <span class="nx">user</span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span><span class="p">):</span> <span class="nx">User</span>
<span class="p">}</span>

<span class="nx">type</span> <span class="nx">Mutation</span> <span class="p">{</span>
  <span class="nx">signup</span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span><span class="p">):</span> <span class="nx">User</span><span class="o">!</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Define the resolvers and query in <code>src/index.ts</code>. <a href="https://github.com/abuiles/anchorx-api/commit/5d6e9155d42c8e07c4c08bb627fdb48613d67e53">Commit 5d6e91</a> shows the changes in the <code>Mutation</code> and <a href="https://github.com/abuiles/anchorx-api/commit/3d3ffffeec77f1e69965d014989379f733b1d65b">commit 3d3fff</a> shows the changes in the <code>Query</code></p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">Query</span><span class="p">:</span> <span class="p">{</span>
    <span class="nx">user</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">},</span> <span class="na">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">user</span><span class="p">(</span>
        <span class="p">{</span>
          <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
            <span class="nx">username</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">info</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">Mutation</span><span class="p">:</span> <span class="p">{</span>
    <span class="nx">signup</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">},</span> <span class="na">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">username</span><span class="p">,</span>
        <span class="na">stellarAccount</span><span class="p">:</span> <span class="s1">'1234'</span><span class="p">,</span>
        <span class="na">stellarSeed</span><span class="p">:</span> <span class="s1">'1234'</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">mutation</span><span class="p">.</span><span class="nx">createUser</span><span class="p">(</span>
        <span class="p">{</span> <span class="nx">data</span> <span class="p">},</span>
        <span class="nx">info</span>
      <span class="p">)</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre>
<p>In this section you will start defining the GraphQL schema and define the resolvers.</p>

<p>Start by defining a mutation called <code>signup</code> and a query called <code>user</code>. The first one takes a username and returns an <code>User</code> instance and the second one allows you to retrieve an user given their username.</p>

<p>Next you need to add the code in the resolvers to support signup and user find, open the file <code>src/index.ts</code> and make sure that it looks like the code on the right. There are links to diffs included so you can see exactly what changed. For this tutorial <a href="https://www.prisma.io">Prisma</a> is taking care of the database and ORM setup.</p>

<p>In the mutation signup, you&#39;ll notice that <code>stellarAccount</code> and <code>stellarSeed</code> have a fixed value of <code>1234</code>, that&#39;s just a placeholder. In the next section will add the <code>JS Stellar SDK</code> and use it to generate the account and the seed, also we&#39;ll add a fake service to encrypt the seed before saving it to the database.</p>

<p>You can see all the changes in this section in <a href="https://github.com/abuiles/anchorx-api/pull/3/files">pull request #3</a></p>
<h2 id='assigning-a-stellar-account-to-new-users'>Assigning a Stellar account to new users</h2>
<blockquote>
<p>Install the stellar-sdk and then the TypeScript types for the stellar-sdk</p>
</blockquote>
<pre class="highlight plaintext"><code>yarn add stellar-sdk
yarn add @types/stellar-sdk
</code></pre>
<p>When a user signup the service will generate a Stellar account. First you need to install the <code>JS Stellar SDK</code> and the types definitions for <code>TypeScript</code>.</p>

<p>After installing the SDK, you need to change the signup mutation so it generates a real public key and seed. To do so, the <code>Stellar SDK</code> has a class called <a href="https://stellar.github.io/js-stellar-sdk/Keypair.html">Keypair</a>. You&#39;ll need to import Keypair and then call <code>Keypair.random()</code> to generate a new pair.</p>

<p>On the right you can  see the changes to <code>src/index.ts</code>.</p>
<pre class="highlight javascript tab-javascript"><code> <span class="kr">import</span> <span class="p">{</span> <span class="nx">importSchema</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'graphql-import'</span>
 <span class="kr">import</span> <span class="p">{</span> <span class="nx">Prisma</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./generated/prisma'</span>
 <span class="kr">import</span> <span class="p">{</span> <span class="nx">Context</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./utils'</span>
<span class="o">+</span><span class="kr">import</span> <span class="p">{</span> <span class="nx">Keypair</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

 <span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
   <span class="na">Query</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
   <span class="p">},</span>
   <span class="na">Mutation</span><span class="p">:</span> <span class="p">{</span>
     <span class="nx">signup</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">},</span> <span class="na">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">keypair</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span>
<span class="o">+</span>
       <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
         <span class="nx">username</span><span class="p">,</span>
<span class="o">+</span>        <span class="na">stellarAccount</span><span class="p">:</span> <span class="nx">keypair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">(),</span>
<span class="o">+</span>        <span class="na">stellarSeed</span><span class="p">:</span> <span class="nx">keypair</span><span class="p">.</span><span class="nx">secret</span><span class="p">()</span>
       <span class="p">}</span>

       <span class="p">...</span>
</code></pre>
<p>You should never store seed keys as plain text. In a production app you should probably be using something like Google or AWS KMS and have a clear set of restrictions of who can encrypt or decrypt. In this tutorial you&#39;ll be using an encryption module for Node called <code>crypto-js</code>. In the next section you will add the module and encrypt the seed before saving it.</p>
<h2 id='encrypting-the-seed'>Encrypting the seed</h2>
<blockquote>
<p>Add the crypto-js module with its types.</p>
</blockquote>
<pre class="highlight plaintext"><code>yarn add crypto-js
yarn add @types/crypto-js
</code></pre>
<blockquote>
<p>Use crypto-js before storing the seed key</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code> <span class="kr">import</span> <span class="p">{</span> <span class="nx">Prisma</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./generated/prisma'</span>
 <span class="kr">import</span> <span class="p">{</span> <span class="nx">Context</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./utils'</span>
 <span class="kr">import</span> <span class="p">{</span> <span class="nx">Keypair</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>
<span class="o">+</span><span class="kr">import</span> <span class="p">{</span> <span class="nx">AES</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'crypto-js'</span>

 <span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
   <span class="na">Query</span><span class="p">:</span> <span class="p">{</span>
     <span class="nx">signup</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">},</span> <span class="na">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
       <span class="kr">const</span> <span class="nx">keypair</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span>

<span class="o">+</span>      <span class="kr">const</span> <span class="nx">configCryptoScret</span> <span class="o">=</span> <span class="s1">'StellarIsAwesome-But-Do-Not-Put-This-Value-In-Code'</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">secret</span> <span class="o">=</span> <span class="nx">AES</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span>
<span class="o">+</span>        <span class="nx">keypair</span><span class="p">.</span><span class="nx">secret</span><span class="p">(),</span>
<span class="o">+</span>        <span class="nx">configCryptoScret</span>
<span class="o">+</span>      <span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
<span class="o">+</span>
       <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
         <span class="nx">username</span><span class="p">,</span>
         <span class="na">stellarAccount</span><span class="p">:</span> <span class="nx">keypair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">(),</span>
<span class="o">-</span>        <span class="na">stellarSeed</span><span class="p">:</span> <span class="nx">keypair</span><span class="p">.</span><span class="nx">secret</span><span class="p">()</span>
<span class="o">+</span>        <span class="na">stellarSeed</span><span class="p">:</span> <span class="nx">secret</span>
       <span class="p">}</span>

       <span class="p">...</span>
</code></pre>
<p>Install <code>crypto-js</code> and after that you can use it in the <code>signup</code> mutation to store the encrypted seed.</p>

<aside class="notice">
For production applications never put any kind of keys in code and use something like Google KMS or AWS KMS to store data securely! You can find a production ready example in StellarGuard. Check the code <a href="https://github.com/stellarguard/stellarguard/blob/master/src/server/lib/utils/crypto.js#L25">here</a>
</aside>

<p>You can see the changes from the previous two sections in <a href="https://github.com/abuiles/anchorx-api/pull/4">pull request #4</a></p>
<h2 id='testing'>Testing</h2><pre class="highlight javascript tab-javascript"><code><span class="nx">mutation</span> <span class="p">{</span>
  <span class="nx">signup</span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="s2">"test"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">id</span><span class="p">,</span>
    <span class="nx">username</span><span class="p">,</span>
    <span class="nx">stellarSeed</span><span class="p">,</span>
    <span class="nx">stellarAccount</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>You can test the changes made up to this point by running the server. To do so type the command <code>yarn dev</code> in your console and it will bring a GraphQL playground to your browser. You can test the <code>signup mutation</code> by pasting the code in the right and hitting run.</p>

<p>AnchorX allows you now to create new users and it assigns a stellar account to each user. However, the Stellar account is not created in the Stellar ledger until it gets funded with some lumens.</p>

<p>The GIF below, shows you the process of creating an account and what happens when you try to look at that account on the stellar test network.</p>

<p>The result is a 404 since you never funded the Stellar account.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/0D2x0C3Y3i2C0J2q1i1L/Screen%20Recording%202018-06-28%20at%2011.14%20AM.gif?X-CloudApp-Visitor-Id=49274&amp;v=df174936" alt="Screen%20recording%202018 06 28%20at%2011.14%20am" /></p>

<p>To fix this, AnchorX needs to fund each account with enough lumens to
keep the minimum account balance and then be able to do
transactions. In the next section you will learn how to create account
programatically in Stellar without <code>friendbot</code>.</p>

<aside class="notice">
Lear more about minimum account balance <a href="https://www.stellar.org/developers/guides/concepts/fees.html#minimum-account-balance">here</a>
</aside>
<h2 id='creating-the-account-in-the-stellar-ledger'>Creating the account in the Stellar ledger</h2><pre class="highlight javascript tab-javascript"><code><span class="c1">// Classes required to create new account</span>
<span class="kr">import</span> <span class="p">{</span>
  <span class="nx">Keypair</span><span class="p">,</span> <span class="c1">// Keypair represents public and secret keys.</span>
  <span class="nx">Network</span><span class="p">,</span> <span class="c1">// Network provides helper methods to get the passphrase or id for different stellar networks.</span>
  <span class="nx">Operation</span><span class="p">,</span> <span class="c1">// Operation helps you represent/build operations in Stellar network.</span>
  <span class="nx">Server</span><span class="p">,</span> <span class="c1">// Server handles the network connections.</span>
  <span class="nx">TransactionBuilder</span> <span class="c1">// Helps you construct transactions.</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="c1">// Tell the Stellar SDK you are using the testnet</span>
  <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">();</span>
  <span class="c1">// point to testnet host</span>
  <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">);</span>

  <span class="c1">// Never put values like the an account seed in code.</span>
  <span class="kr">const</span> <span class="nx">provisionerKeyPair</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">fromSecret</span><span class="p">(</span><span class="s1">'SA72TGXRHE26WC5G5MTNURFUFBHZHTIQKF5AQWRXJMJGZUF4XY6HFWJ4'</span><span class="p">)</span>

  <span class="c1">// Load account from Stellar</span>
  <span class="kr">const</span> <span class="nx">provisioner</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">provisionerKeyPair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'creating account in ledger'</span><span class="p">,</span> <span class="nx">keypair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>
  <span class="kr">const</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">provisioner</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
          <span class="c1">// Operation to create new accounts</span>
          <span class="nx">Operation</span><span class="p">.</span><span class="nx">createAccount</span><span class="p">({</span>
            <span class="na">destination</span><span class="p">:</span> <span class="nx">keypair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">(),</span>
            <span class="na">startingBalance</span><span class="p">:</span> <span class="s1">'2'</span>
          <span class="p">})</span>
        <span class="p">).</span><span class="nx">build</span><span class="p">()</span>

  <span class="c1">// Sign the transaction above</span>
  <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">provisionerKeyPair</span><span class="p">)</span>

  <span class="c1">// Submit transaction to the server</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Account created: '</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Stellar account not created.'</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<p>The Stellar SDK includes a transaction builder which helps you create operations. To create an account, you&#39;ll need to use the <a href="https://stellar.github.io/js-stellar-sdk/Operation.html#.createAccount">createAccount operation</a>. The code on the right includes the relevant pieces to create a new account programmatically.</p>

<p>You can follow along and read the comment on what each line represents. After that you&#39;ll need to use that code in the context of the signup mutation to create the account in the Stellar ledger.</p>

<p>You need to extend the signup mutation to fund the user&#39;s account after it has been created successfully.</p>

<p>You can find in <a href="https://github.com/abuiles/anchorx-api/pull/5">pull request #5</a> the change in the mutation using the create account operation.</p>

<aside class="notice">
In a production app, you probably want to have all the code interacting with Stellar accounts and secret keys in a different service like AWS Lambda. Also make use of AWS IAM policies, KMS and force MFA.
</aside>
<h2 id='payments'>Payments</h2><pre class="highlight javascript tab-javascript"><code> <span class="kr">import</span> <span class="p">{</span>
 <span class="o">+</span> <span class="nx">Asset</span><span class="p">,</span>
   <span class="nx">Keypair</span><span class="p">,</span>
 <span class="o">+</span> <span class="nx">Memo</span>
   <span class="nx">Network</span><span class="p">,</span>
   <span class="nx">Operation</span><span class="p">,</span>
   <span class="nx">Server</span><span class="p">,</span>
   <span class="nx">TransactionBuilder</span>
 <span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

 <span class="kr">import</span> <span class="p">{</span>
   <span class="nx">AES</span><span class="p">,</span>
 <span class="o">+</span> <span class="nx">enc</span>
 <span class="p">}</span> <span class="nx">from</span> <span class="s1">'crypto-js'</span><span class="nx">xo</span>

 <span class="kr">const</span> <span class="nx">ENVCryptoSecret</span> <span class="o">=</span> <span class="s1">'StellarIsAwesome-But-Do-Not-Put-This-Value-In-Code'</span>

   <span class="nl">mutations</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span>
<span class="o">+</span>    <span class="nx">async</span> <span class="nx">payment</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">senderUsername</span><span class="p">,</span> <span class="nx">recipientUsername</span><span class="p">,</span> <span class="nx">memo</span> <span class="p">},</span> <span class="nx">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>      <span class="c1">// Load users from database</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">users</span><span class="p">({</span>
<span class="o">+</span>        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
<span class="o">+</span>          <span class="na">username_in</span><span class="p">:</span> <span class="p">[</span><span class="nx">senderUsername</span><span class="p">,</span> <span class="nx">recipientUsername</span><span class="p">]</span>
<span class="o">+</span>        <span class="p">}</span>
<span class="o">+</span>      <span class="p">})</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">sender</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">u</span> <span class="o">=&gt;</span> <span class="nx">u</span><span class="p">.</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">senderUsername</span><span class="p">)</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">recipient</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">u</span> <span class="o">=&gt;</span> <span class="nx">u</span><span class="p">.</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">recipientUsername</span><span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">();</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">);</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="c1">// build the keypair required to sign the payment transaction</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">signerKeys</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">fromSecret</span><span class="p">(</span>
<span class="o">+</span>        <span class="c1">// Use something like KMS in production</span>
<span class="o">+</span>        <span class="nx">AES</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span>
<span class="o">+</span>          <span class="nx">recipient</span><span class="p">.</span><span class="nx">stellarSeed</span><span class="p">,</span>
<span class="o">+</span>          <span class="nx">ENVCryptoSecret</span>
<span class="o">+</span>        <span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="nx">enc</span><span class="p">.</span><span class="nx">Utf8</span><span class="p">)</span>
<span class="o">+</span>      <span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="c1">// Load Stellar account from ledger</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">account</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">sender</span><span class="p">.</span><span class="nx">stellarAccount</span><span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="cm">/*
+        Payments require an asset type, for now users will be sending
+        lumens. In the next chapter you'll create a custom asset
+        representing Dollars and use it.
+      */</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">asset</span> <span class="o">=</span> <span class="nx">Asset</span><span class="p">.</span><span class="kr">native</span><span class="p">()</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="kd">let</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span>
<span class="o">+</span>        <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
<span class="o">+</span>          <span class="nx">Operation</span><span class="p">.</span><span class="nx">payment</span><span class="p">({</span>
<span class="o">+</span>            <span class="na">destination</span><span class="p">:</span> <span class="nx">sender</span><span class="p">.</span><span class="nx">stellarAccount</span><span class="p">,</span>
<span class="o">+</span>            <span class="nx">asset</span><span class="p">,</span>
<span class="o">+</span>            <span class="nx">amount</span>
<span class="o">+</span>          <span class="p">})</span>
<span class="o">+</span>        <span class="p">).</span><span class="nx">build</span><span class="p">()</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">signerKeys</span><span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="k">try</span> <span class="p">{</span>
<span class="o">+</span>        <span class="kr">const</span> <span class="p">{</span> <span class="nx">hash</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>        <span class="k">return</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">hash</span> <span class="p">}</span>
<span class="o">+</span>      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`failure </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>        <span class="k">throw</span> <span class="nx">e</span>
<span class="o">+</span>      <span class="p">}</span>
<span class="o">+</span>    <span class="p">}</span>
   <span class="p">},</span>
 <span class="p">}</span>
</code></pre>
<p>In Venmo you can send payments using the recipient&#39;s phone number,
email or username. In AnchorX users will be sending money to each
other using their usernames. To keep things simple, you won&#39;t
implement any kind of session management which means you&#39;ll have to
tell the API explicitly who is the sender and the recipient. For
production apps this is very BAD IDEA, but the goal here is not to
build an user management or Authn/Authz system.</p>

<p>To send a payment in Stellar, you need the recipient&#39;s Stellar account
and source account secret.</p>

<p>The code in the right shows the mutation to create new payments. It
takes the sender and recipient username as parameters. It loads first
the user&#39;s data from the database, decrypts the sender seed and then
signs the transaction to submit a payment.</p>

<aside class="notice">
If you are freaking out about decrypting the seed and signing the
transaction with it, don't worry. You will learn more about other ways
to deal with account seeds and signing transactions in a different section.
</aside>

<p>Payments are created using the payment <code>payment</code> function from the
<code>Operation</code> class. You can see it takes the destination, the
asset and the amount.</p>

<p>Since Stellar accounts can hold multiple assets you need to specify
which of the assets held by an account you are trying to transfer. For
now the operation is sending lumens. In AnchorX, users won&#39;t be
sending lumens to each other but the custom asset representing USD.</p>

<p>In the upcoming sections you will:</p>

<ul>
<li>Create a custom asset representing Dollars.</li>
<li>Learn how to allow accounts to hold that asset.</li>
<li>Implement the <code>creditAccount</code> mutation which simulates transferring Dollars from the user bank account to AnchorX.</li>
<li>Change the payment mutation to send USD instead of lumens.</li>
</ul>

<p><a href="https://github.com/abuiles/anchorx-api/pull/7">Pull request #7</a> includes all the changes introduced in this section.</p>
<h2 id='issuing-anchorx-custom-asset'>Issuing AnchorX custom asset</h2>
<p>In this section you&#39;ll learn the high level details of issuing a new asset and how to allow other accounts to hold your asset. Stellar&#39;s official documentation has a great guide about issuing assets so this tutorial won&#39;t repeat the same. You can read more about it here <a href="https://www.stellar.org/developers/guides/issuing-assets.html">https://www.stellar.org/developers/guides/issuing-assets.html</a></p>

<p>To create an asset you&#39;ll need an asset code and an issuing account.</p>

<p>The asset code needs a short identifier, for national currencies you need to use an <a href="https://en.wikipedia.org/wiki/ISO_4217">ISO 4217 code</a>. AnchorX asset will use the code <code>USD</code>.</p>

<p>The issuing account can emit new <code>USD</code>, give it to other accounts and impose some controls around it. In this tutorial the issuing account will be <code>GBX67BEOABQAELIP2XTC6JXHJPASKYCIQNS7WF6GWPSCBEAJEK74HK36</code> with seed <code>SBYZ5NEJ34Y3FTKADVBO3Y76U6VLTREJSW4MXYCVMUBTL2K3V4Y644UX</code>.</p>

<p>Before an account can hold a given asset, it needs to explicitly create
an operation expressing that it trust the asset with code <code>USD</code>
created by the issuing account
<code>GBX67BEOABQAELIP2XTC6JXHJPASKYCIQNS7WF6GWPSCBEAJEK74HK36</code>, such
operation is called creating a <code>trustline</code>.</p>

<p>The issuer can set a condition where it needs to authorize accounts
before they can hold its asset, this is useful if you only want people
who are your clients or have gone through your KYC process to transact
with your asset. In this scenario you need two trustlines one from the customer&#39;s account to your issuing account and then one from your issuing account to the customer&#39;s account.</p>
<h2 id='setting-up-issuing-account'>Setting up issuing account</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="p">{</span>
  <span class="nx">AuthRequiredFlag</span><span class="p">,</span>
  <span class="nx">AuthRevocableFlag</span><span class="p">,</span>
  <span class="nx">Server</span><span class="p">,</span>
  <span class="nx">Keypair</span><span class="p">,</span>
  <span class="nx">Network</span><span class="p">,</span>
  <span class="nx">Operation</span><span class="p">,</span>
  <span class="nx">TransactionBuilder</span><span class="p">,</span>
  <span class="nx">xdr</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">setupIssuer</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">()</span>

  <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">issuerKeyPair</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">fromSecret</span><span class="p">(</span><span class="s1">'SBYZ5NEJ34Y3FTKADVBO3Y76U6VLTREJSW4MXYCVMUBTL2K3V4Y644UX'</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">issuingAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">issuerKeyPair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>

  <span class="kd">var</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">issuingAccount</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
        <span class="nx">Operation</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">({</span>
          <span class="na">setFlags</span><span class="p">:</span> <span class="nx">AuthRevocableFlag</span> <span class="o">|</span> <span class="nx">AuthRequiredFlag</span>
        <span class="p">}))</span>
      <span class="p">.</span><span class="nx">build</span><span class="p">()</span>

  <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">issuerKeyPair</span><span class="p">)</span>
  <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">)</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'All set!'</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">setupIssuer</span><span class="p">()</span>

</code></pre>
<p>The code on the right shows you the basic setup for an account before creating an asset. In it, you are setting the <code>AuthRequiredFlag</code> which requires the trustline from the issuer to the holder and <code>AuthRevocableFlag</code> which allows you to freeze the user&#39;s access to your asset. You can read more about both flags <a href="https://www.stellar.org/developers/guides/concepts/assets.html#controlling-asset-holders">here</a>. Since this is something which is done once, this is not included in the GitHub repo. You can try it in <a href="https://repl.it/@abuiles/SetupAnchorFlags">Repl.it</a></p>

<p>Next you need to extend the signup mutation to create both trustlines when an user creates a new account.</p>
<h2 id='creating-a-trustline'>Creating a trustline</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="p">{</span>
  <span class="nx">Asset</span><span class="p">,</span>
  <span class="nx">Keypair</span><span class="p">,</span>
  <span class="nx">Network</span><span class="p">,</span>
  <span class="nx">Operation</span><span class="p">,</span>
  <span class="nx">Server</span><span class="p">,</span>
  <span class="nx">TransactionBuilder</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

<span class="kr">export</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">createTrustline</span><span class="p">(</span><span class="nx">accountKeypair</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">);</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">account</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">accountKeypair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>
    <span class="kr">const</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
        <span class="nx">Operation</span><span class="p">.</span><span class="nx">changeTrust</span><span class="p">({</span>
          <span class="na">asset</span><span class="p">:</span> <span class="nx">AnchorXUSD</span>
        <span class="p">}))</span>
      <span class="p">.</span><span class="nx">build</span><span class="p">();</span>

    <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">accountKeypair</span><span class="p">)</span>

    <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">)</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'trustline created from  account to issuer and signers updated'</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">result</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'create trustline failed.'</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>The code on the right shows you how to create a trustline from an account to the issuer account. You&#39;ll be using that function inside the signup mutation.</p>

<p>Now after you create a new user, you will also create a trustline from the new account to AnchorX asset. You are not done yet, although the account accepts AnchorX <code>USD</code>, if you try to send <code>USD</code> to that account it won&#39;t work because the account hasn&#39;t been authorized to hold the asset.</p>

<p>After a trustline is created, you&#39;ll see the custom asset in the account&#39;s balance.</p>

<p>The following GIF shows you an account&#39;s state after it gets created without the trustline to AnchorX asset. You can see that the balance key only shows native.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/113r1e353x3S1s1V2k2I/Screen%20Recording%202018-07-09%20at%2002.56%20PM.gif?X-CloudApp-Visitor-Id=49274&amp;v=559df5f9" alt="Screen%20recording%202018 07 09%20at%2002.56%20pm" /></p>

<p>And the next one will show you what happens in the account after creating the trustline.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/0r2R1z2h2g2p2t3L3O0m/Screen%20Recording%202018-07-09%20at%2003.00%20PM.gif?X-CloudApp-Visitor-Id=49274&amp;v=a19639ff" alt="Screen%20recording%202018 07 09%20at%2003.00%20pm" /></p>

<p>You can see the changes from this section in <a href="https://github.com/abuiles/anchorx-api/pull/8">pull request #8</a>.</p>
<h2 id='allow-trustline'>Allow trustline</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">export</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">allowTrust</span><span class="p">(</span><span class="nx">trustor</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">);</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// Never store secrets in code! Use something like KMS and put</span>
    <span class="c1">// this somewhere were few people can access it.</span>
    <span class="kr">const</span> <span class="nx">issuingKeys</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">fromSecret</span><span class="p">(</span><span class="s1">'SBYZ5NEJ34Y3FTKADVBO3Y76U6VLTREJSW4MXYCVMUBTL2K3V4Y644UX'</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">issuingAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">issuingKeys</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>

    <span class="kr">const</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">issuingAccount</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
        <span class="nx">Operation</span><span class="p">.</span><span class="nx">allowTrust</span><span class="p">({</span>
          <span class="nx">trustor</span><span class="p">,</span>
          <span class="na">assetCode</span><span class="p">:</span> <span class="nx">AnchorXUSD</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span>
          <span class="na">authorize</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">})</span>
      <span class="p">)</span>
      <span class="p">.</span><span class="nx">build</span><span class="p">();</span>

    <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">issuingKeys</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">)</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'trust allowed'</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">result</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'allow trust failed'</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>On the right you can see the allow trust operation in used. It
receives the public key of the account that you want to authorize and
the asset&#39;s code.</p>

<p>Now you can use that function after calling <code>createTrustline</code>. <a href="https://github.com/abuiles/anchorx-api/pull/9/files">Pull request #9</a> shows you how to use the <code>allowTrust</code> function inside the signup mutation.</p>
<h2 id='welcome-balance'>Welcome balance</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">export</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">payment</span><span class="p">(</span><span class="nx">signerKeys</span><span class="p">:</span> <span class="nx">Keypair</span><span class="p">,</span> <span class="nx">destination</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">amount</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">);</span>

  <span class="kr">const</span> <span class="nx">account</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">signerKeys</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>

  <span class="kd">let</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
      <span class="nx">Operation</span><span class="p">.</span><span class="nx">payment</span><span class="p">({</span>
        <span class="nx">destination</span><span class="p">,</span>
        <span class="na">asset</span><span class="p">:</span> <span class="nx">AnchorXUSD</span><span class="p">,</span>
        <span class="nx">amount</span>
      <span class="p">})</span>
    <span class="p">).</span><span class="nx">addMemo</span><span class="p">(</span><span class="nx">Memo</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">'https://goo.gl/6pDRPi'</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">build</span><span class="p">()</span>

  <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">signerKeys</span><span class="p">)</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">hash</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">hash</span> <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`failure </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
    <span class="k">throw</span> <span class="nx">e</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>In theory, AnchorX and the Stellar accounts it creates are ready to
receive and send <code>USD</code>. AnchorX&#39;s growth hackers have decided that the
best way to bring people to the platform is by giving each user a
welcome bonus of $10 USD.</p>

<p>You need to extend the signup mutation to send new users $10 USD. Add the function on the right to utils and then call it after the allow trustline operation.</p>

<p>The function takes the signing keys for the account to be debited, the destination account and the amount.</p>

<aside class="notice">
You might have noticed the use of the issuing account to send the welcome bonus. In practice this is a bad idea, since if that account gets compromised, it means all AnchorX operations will be compromised. You'll learn more about how to deal with this situation later. If you can't wait, check [the account structure guide](https://www.stellar.org/developers/guides/anchor/index.html#account-structure) in the official docs.
</aside>

<p>You can use the payment function inside the signup mutation.</p>

<p>The following GIF show you how after creating new accounts, they end up with $10 USD in their balance.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/0n1c1o2o0F2P2H0c3K1b/Screen%20Recording%202018-07-09%20at%2004.41%20PM.gif?X-CloudApp-Visitor-Id=49274&amp;v=c08071af" alt="Screen%20recording%202018 07 09%20at%2004.41%20pm" /></p>

<p><a href="https://github.com/abuiles/anchorx-api/pull/10">Pull request #10</a>
includes all the changes introduced in this section. Now that AnchorX
users can hold USD, let&#39;s replace the payment mutation to send USD and
also give them a way to debit or credit their accounts.</p>
<h2 id='paying-with-usd'>Paying with USD</h2><pre class="highlight javascript tab-javascript"><code>    <span class="nx">async</span> <span class="nx">payment</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">senderUsername</span><span class="p">,</span> <span class="nx">recipientUsername</span><span class="p">,</span> <span class="nx">memo</span> <span class="p">},</span> <span class="nx">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">users</span><span class="p">({</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">username_in</span><span class="p">:</span> <span class="p">[</span><span class="nx">senderUsername</span><span class="p">,</span> <span class="nx">recipientUsername</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">})</span>

      <span class="kr">const</span> <span class="nx">sender</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">u</span> <span class="o">=&gt;</span> <span class="nx">u</span><span class="p">.</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">senderUsername</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">recipient</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">u</span> <span class="o">=&gt;</span> <span class="nx">u</span><span class="p">.</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">recipientUsername</span><span class="p">)</span>

      <span class="kr">const</span> <span class="nx">signerKeys</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">fromSecret</span><span class="p">(</span>
        <span class="c1">// Use something like KMS in production</span>
        <span class="nx">AES</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span>
          <span class="nx">sender</span><span class="p">.</span><span class="nx">stellarSeed</span><span class="p">,</span>
          <span class="nx">ENVCryptoSecret</span>
        <span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="nx">enc</span><span class="p">.</span><span class="nx">Utf8</span><span class="p">)</span>
      <span class="p">)</span>

      <span class="k">try</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="p">{</span> <span class="nx">hash</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">payment</span><span class="p">(</span>
          <span class="nx">signerKeys</span><span class="p">,</span>
          <span class="nx">recipient</span><span class="p">.</span><span class="nx">stellarAccount</span><span class="p">,</span>
          <span class="nx">amount</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">hash</span> <span class="p">}</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`failure </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>

        <span class="k">throw</span> <span class="nx">e</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre>
<p>You have a payment mutation to allow people to send money between each other. Until now it was sending the native asset but since users can hold USD you need to replace it to send USD. To do so, you can use the payment function from the previous section.</p>

<p>The code on the right shows you the new version of the payment mutation, which uses the <code>payment</code> function.</p>

<p>The following GIF show you the payment mutation in action.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/2m06171D3o3x1O2p3c3Z/Screen%20Recording%202018-07-09%20at%2005.06%20PM.gif?X-CloudApp-Visitor-Id=49274&amp;v=e39af9cd" alt="Screen%20recording%202018 07 09%20at%2005.06%20pm" /></p>

<p>[Pull request #11[(https://github.com/abuiles/anchorx-api/pull/11) shows you the changes introduced in this section.</p>
<h2 id='credit-account'>Credit account</h2><pre class="highlight javascript tab-javascript"><code><span class="nx">async</span> <span class="nx">credit</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">username</span> <span class="p">},</span> <span class="nx">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">user</span><span class="p">({</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">username</span><span class="p">:</span> <span class="nx">username</span>
        <span class="p">}</span>
      <span class="p">})</span>

      <span class="k">try</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="p">{</span> <span class="nx">hash</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">payment</span><span class="p">(</span>
          <span class="c1">// keypair for issuing account - no bueno</span>
          <span class="nx">Keypair</span><span class="p">.</span><span class="nx">fromSecret</span><span class="p">(</span><span class="s1">'SBYZ5NEJ34Y3FTKADVBO3Y76U6VLTREJSW4MXYCVMUBTL2K3V4Y644UX'</span><span class="p">),</span>
          <span class="nx">user</span><span class="p">.</span><span class="nx">stellarAccount</span><span class="p">,</span>
          <span class="nx">amount</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">hash</span> <span class="p">}</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`failure </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>

        <span class="k">throw</span> <span class="nx">e</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre>
<p>In this section you will implement a new mutation to credit an user&#39;s account with <code>USD</code>. This mutation simulates a callback which would have been called if you were integrating your system with ACH or a similar system. In the context of the tutorial, this will be called when the user sends money from their bank account to AnchorX.</p>

<p>The mutation takes the username and the amount to be credited. Since you are using the issues keys, you can see that every time a new credit happens, the amount of <code>USD</code> minted increases.</p>

<p>To see how much is in circulation for a given asset you can visit the <a href="https://www.stellar.org/developers/horizon/reference/resources/asset.html">horizon end-point for assets</a> filtering by code and issuer. The URL for AnchorX <code>USD</code> is the following <a href="https://horizon-testnet.stellar.org/assets?order=desc&amp;asset_code=USD&amp;asset_issuer=GBX67BEOABQAELIP2XTC6JXHJPASKYCIQNS7WF6GWPSCBEAJEK74HK36">https://horizon-testnet.stellar.org/assets?order=desc&amp;asset_code=USD&amp;asset_issuer=GBX67BEOABQAELIP2XTC6JXHJPASKYCIQNS7WF6GWPSCBEAJEK74HK36</a></p>

<p>The code in the right shows you the mutation and <a href="https://github.com/abuiles/anchorx-api/pull/12">pull request #12</a> includes the change in the project.</p>

<p>The GIF below shows you the credit mutation in action and how the amount of <code>USD</code> increases after you credit accounts.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/252J2G111Q1a261j2D1X/Screen%20Recording%202018-07-10%20at%2010.57%20AM.gif?X-CloudApp-Visitor-Id=49274&amp;v=7b4cf1e8" alt="Screen%20recording%202018 07 10%20at%2010.57%20am" /></p>
<h2 id='debit-account'>Debit account</h2><pre class="highlight javascript tab-javascript"><code><span class="nx">async</span> <span class="nx">debit</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">username</span> <span class="p">},</span> <span class="nx">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">user</span><span class="p">({</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">username</span><span class="p">:</span> <span class="nx">username</span>
        <span class="p">}</span>
      <span class="p">})</span>

      <span class="kr">const</span> <span class="nx">keypair</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">fromSecret</span><span class="p">(</span>
        <span class="nx">AES</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span>
          <span class="nx">user</span><span class="p">.</span><span class="nx">stellarSeed</span><span class="p">,</span>
          <span class="nx">ENVCryptoSecret</span>
        <span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="nx">enc</span><span class="p">.</span><span class="nx">Utf8</span><span class="p">)</span>
      <span class="p">)</span>

      <span class="c1">// When you send back a custom asset to the issuing account, the</span>
      <span class="c1">// asset you send back get destroyed</span>
      <span class="kr">const</span> <span class="nx">issuingAccount</span> <span class="o">=</span> <span class="s1">'GBX67BEOABQAELIP2XTC6JXHJPASKYCIQNS7WF6GWPSCBEAJEK74HK36'</span>

      <span class="k">try</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="p">{</span> <span class="nx">hash</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">payment</span><span class="p">(</span>
          <span class="nx">keypair</span><span class="p">,</span>
          <span class="nx">issuingAccount</span><span class="p">,</span>
          <span class="nx">amount</span>
        <span class="p">)</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`account </span><span class="p">${</span><span class="nx">keypair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">()}</span><span class="s2"> debited - now transfer real money to </span><span class="p">${</span><span class="nx">username</span><span class="p">}</span><span class="s2"> bank account`</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">hash</span> <span class="p">}</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`failure </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>

        <span class="k">throw</span> <span class="nx">e</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre>
<p>In this section you will implement a new mutation to debit money from an user&#39;s account. This mutation simulates a callback which would have been called if you were integrating sending money to user&#39;s bank account. In AnchorX, this will be use when the user wants to withdraw money from AnchorX.</p>

<p>When crediting account you saw that <code>USD</code> was being minted. For debiting, you&#39;ll be doing the opposite process, taking <code>USD</code> from an user&#39;s account and sending it back to the issuing account. In Stellar, when an asset is sent back to the issuing account, it gets destroyed.</p>

<p>The code on the right shows the debit mutation. It is very similar to the credit operation, but the difference is that the destination is the issuing account. <a href="https://github.com/abuiles/anchorx-api/pull/13">Pull request #13</a> shows the changes in the mutation and schema.</p>

<p>The following GIF shows you the debit mutation and how assets get destroyed after sending them back.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/2f382x1B1T123J3T1c3d/Screen%20Recording%202018-07-10%20at%2011.28%20AM.gif?X-CloudApp-Visitor-Id=49274&amp;v=4a3a8dc0" alt="Screen%20recording%202018 07 10%20at%2011.28%20am" /></p>
<h2 id='conclusion'>Conclusion</h2>
<p>Congratulations! You have now a very basic implementation of AnchorX API. In this chapter you learnt:</p>

<ul>
<li><a href="#creating-the-account-in-the-stellar-ledger">How to create Stellar accounts programatically.</a></li>
<li><a href="#issuing-anchorx-custom-asset">How to issue new assets in Stellar.</a></li>
<li><a href="#creating-a-trustline">How to create trustlines in Stellar and authorize truslines.</a></li>
<li><a href="#payments">Signing transactions and making payments with Stellar.</a></li>
<li><a href="#credit-account">What happens after an issuing account issues more assets.</a></li>
<li><a href="#debit-account">What happens after an issuing account receives back issued assets.</a></li>
</ul>

<p>In the next chapter you&#39;ll be building a mobile wallet in React Native to allow AnchorX customer to interact with their accounts. You&#39;ll also learn how to use the Stellar JS SDK to read accounts data and follow payments. After you build the wallet, you will learn about best practices like managing secret keys, using a base account along with the issuing account, how to setup multisignatutre schemas and security considerations.</p>
<h1 id='building-the-mobile-wallet'>Building the mobile wallet</h1>
<p>In this chapter you&#39;ll learn how to use the Stellar JS SDK in React
Native and use it to display balances and transactions. This tutorial
won&#39;t go into details on things which are not related with Stellar
like setting up React Native, navigation, setting Apollo, etc. This
tutorial includes a boilerplate project which has all the basics already setup.</p>

<p>When interacting with Stellar, you will find a detailed section explaining what&#39;s happening.</p>

<p>The wallet will be written using the following technologies:</p>

<ul>
<li><a href="https://facebook.github.io/react-native/">React Native</a>.</li>
<li><a href="https://www.typescriptlang.org/">TypeScript</a>.</li>
<li><a href="https://www.apollographql.com/">GraphQL with Apollo</a>.</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/app/react-native">Storybook</a>.</li>
<li><a href="https://nativebase.io/">NativeBase</a>.</li>
<li><a href="https://github.com/react-navigation/react-navigation">React-Navigation</a>.</li>
</ul>
<h2 id='mobile-wallet-boilerplate'>Mobile wallet boilerplate</h2>
<p>The following GIF shows you all the screens and functionality included in the mobile wallet boilerplate.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/1a132y2a340n1Y272Z1S/Screen%20Recording%202018-07-17%20at%2011.06%20AM.gif?X-CloudApp-Visitor-Id=49274&amp;v=78531abe" alt="Screen%20recording%202018 07 17%20at%2011.06%20am" /></p>

<p>As you can see the login/signup screen is already configured to consume the <code>GraphQL</code> API. After the user signs in you will display the balance and transaction history and give the user the option to make new payments.</p>

<p>Before downloading the boilerplate, install the required dependencies to run React Native applications. You can find the list of requirements in the following page <a href="https://facebook.github.io/react-native/docs/getting-started">https://facebook.github.io/react-native/docs/getting-started</a>, click in <code>Build Projects with Native Code</code> and follow the instructions.</p>

<p>Next, download the boilerplate with the following commands:</p>

<ol>
<li><code>git clone https://github.com/abuiles/StellarMobileWalletBoilerplate AnchorX</code></li>
<li><code>cd AnchorX</code></li>
<li><code>yarn install</code></li>
</ol>

<p>After the dependencies are installed, you should be able to run the Android or iOS version with the following commands:</p>

<ul>
<li>iOS: <code>yarn run ios</code></li>
<li>Android: <code>yarn run android</code></li>
</ul>

<p>Once the application is running start a session by putting your favorite username. You will see a placeholder balance showing <code>$1000</code>, your <code>username</code> and <code>stellarAccount</code>. In the following session you will install the JS Stellar SDK and use it to show the account&#39;s real balance.</p>
<h2 id='using-the-stellar-sdk-in-react-native'>Using the Stellar-SDK in React Native</h2>
<p>Using the JS Stellar SDK requires extra setup because the package depends in some Node core modules like <code>crypto</code> or globals like <code>process</code>, which are not available in React Native.</p>

<p>If you try to run the application and import the SDK, you will see an error like the following:</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/1b13041l020I0s2l0L3o/%5B38cfda07cc131d3a1e9d71bf82fb8887%5D_Image+2018-07-18+at+1.29.16+PM.png?X-CloudApp-Visitor-Id=49274&amp;v=f0422f8c" alt="%5b38cfda07cc131d3a1e9d71bf82fb8887%5d image+2018 07 18+at+1.29.16+pm" /></p>

<p>This is a known issue in the React Native world and there is a solution for it. To solve the problem you need to install the package <a href="https://github.com/parshap/node-libs-react-native">node-libs-react-native
</a> which provides the implementation for some of those modules and <a href="https://github.com/browserify/vm-browserify">vm-browserify</a>.</p>

<p>Run the following commands:</p>

<ul>
<li><code>yarn add node-libs-react-native vm-browserify react-native-randombytes</code></li>
<li><code>react-native link</code></li>
</ul>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// rn-cli.config.js</span>
<span class="kr">const</span> <span class="nx">extraNodeModules</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-libs-react-native'</span><span class="p">)</span>
<span class="nx">extraNodeModules</span><span class="p">.</span><span class="nx">vm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">'vm-browserify'</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">getTransformModulePath</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s2">"react-native-typescript-transformer"</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">getSourceExts</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">"ts"</span><span class="p">,</span> <span class="s2">"tsx"</span><span class="p">];</span>
  <span class="p">},</span>
  <span class="nx">extraNodeModules</span>
<span class="p">};</span>
</code></pre>
<p>Edit the file <code>rn-cli.config.js</code> file in the root directory to look like the code in the right and then add to <code>index.js</code> in the root container the following at the top: <code>import &#39;node-libs-react-native/globals&#39;</code></p>

<p>You can see the changes in <a href="https://github.com/abuiles/AnchorX/pull/10/files">pull request #10</a>. The relevant pieces are:</p>

<ul>
<li><a href="https://github.com/abuiles/AnchorX/pull/10/files#diff-b9cfc7f2cdf78a7f4b91a753d10865a2">package.json</a></li>
<li><a href="https://github.com/abuiles/AnchorX/pull/10/files#diff-41fdc10e1b5862877e4afa7e9176ee09">rn-cli.config.js</a></li>
<li><a href="https://github.com/abuiles/AnchorX/pull/10/files#diff-168726dbe96b3ce427e7fedce31bb0bc">index.js</a></li>
</ul>
<h3 id='installing-the-sdk-and-writing-your-first-component'>Installing the SDK and writing your first component</h3>
<p>Once you have the depencies to install the SDK, run the following command:</p>

<ul>
<li><code>yarn add stellar-sdk @types/stellar-sdk</code></li>
</ul>

<p>Next you need to create a new container component which will load the Stellar account from the ledger and then display the balance for AnchorX custom asset.</p>

<p>The container component will have the following props:</p>

<ul>
<li><code>stellarAccount</code>: Stellar account id to load.</li>
<li><code>asset</code>: since Stellar accounts can hold multiple assets, you&#39;ll tell explicitly to the component which asset to display.</li>
</ul>
<pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span>
<span class="kr">import</span> <span class="p">{</span>
  <span class="nx">Platform</span><span class="p">,</span>
  <span class="nx">StyleSheet</span><span class="p">,</span>
  <span class="nx">View</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-native'</span>

<span class="kr">import</span> <span class="p">{</span>
  <span class="nx">Asset</span><span class="p">,</span>
  <span class="nx">AccountResponse</span><span class="p">,</span>
  <span class="nx">Network</span><span class="p">,</span>
  <span class="nx">Server</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">Text</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'native-base'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">styles</span> <span class="nx">as</span> <span class="nx">s</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-native-style-tachyons'</span>

<span class="kr">import</span> <span class="nx">Loading</span> <span class="nx">from</span> <span class="s1">'../components/Loading'</span>

<span class="kr">interface</span> <span class="nx">Props</span> <span class="p">{</span>
  <span class="nl">accountId</span><span class="p">:</span> <span class="nx">string</span>
  <span class="nl">asset</span><span class="p">:</span> <span class="nx">Asset</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">State</span> <span class="p">{</span>
  <span class="nl">sdkAccount</span><span class="p">:</span> <span class="nx">AccountResponse</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">Balance</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="o">&lt;</span><span class="nx">Props</span><span class="p">,</span> <span class="nx">State</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="na">props</span><span class="p">:</span> <span class="nx">Props</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="p">}</span>

  <span class="nx">async</span> <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">accountId</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>
    <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">)</span>
    <span class="c1">// load the account from Horizon</span>
    <span class="kr">const</span> <span class="nx">sdkAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">accountId</span><span class="p">)</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
      <span class="nx">sdkAccount</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">sdkAccount</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">asset</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sdkAccount</span><span class="p">)</span> <span class="k">return</span> <span class="o">&lt;</span><span class="nx">Loading</span> <span class="o">/&gt;</span>

    <span class="kr">const</span> <span class="p">{</span> <span class="nx">balance</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">sdkAccount</span><span class="p">.</span><span class="nx">balances</span><span class="p">.</span><span class="nx">find</span><span class="p">(({</span> <span class="nx">asset_code</span><span class="p">,</span> <span class="nx">asset_issuer</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">asset_code</span> <span class="o">===</span> <span class="nx">asset</span><span class="p">.</span><span class="nx">code</span> <span class="o">&amp;&amp;</span> <span class="nx">asset_issuer</span> <span class="o">===</span> <span class="nx">asset</span><span class="p">.</span><span class="nx">issuer</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">View</span> <span class="nx">style</span><span class="o">=</span><span class="p">{[</span><span class="nx">s</span><span class="p">.</span><span class="nx">jcc</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">aic</span><span class="p">]}</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">Text</span> <span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">s</span><span class="p">.</span><span class="nx">f3</span><span class="p">}</span><span class="o">&gt;</span>
          <span class="p">{</span><span class="nx">balance</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="sr">/Text</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/View</span><span class="err">&gt;
</span>    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Create the component by running <code>touch app/containers/Balance.tsx</code> and then paste the content on the right.</p>

<blockquote>
<p>Update <code>app/containers/Home.tsx</code> to render the Balance component.</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code> <span class="kr">import</span> <span class="p">{</span> <span class="nx">NavigationScreenProps</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-navigation'</span>
<span class="o">+</span><span class="kr">import</span> <span class="p">{</span> <span class="nx">Asset</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>
<span class="o">+</span>
<span class="o">+</span><span class="kr">import</span> <span class="nx">Balance</span> <span class="nx">from</span> <span class="s1">'./Balance'</span>

 <span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">Home</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="o">&lt;</span><span class="nx">NavigationScreenProps</span><span class="o">&gt;</span> <span class="p">{</span>
   <span class="kr">static</span> <span class="nx">navigationOptions</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">@@</span> <span class="o">-</span><span class="mi">18</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">21</span><span class="p">,</span><span class="mi">11</span> <span class="p">@@</span> <span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">Home</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="o">&lt;</span><span class="nx">NavigationScreenProps</span><span class="o">&gt;</span> <span class="p">{</span>
   <span class="p">}</span>

   <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
<span class="o">+</span>    <span class="kr">const</span> <span class="nx">anchorXUSD</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Asset</span><span class="p">(</span>
<span class="o">+</span>      <span class="s1">'USD'</span><span class="p">,</span>
<span class="o">+</span>      <span class="s1">'GBX67BEOABQAELIP2XTC6JXHJPASKYCIQNS7WF6GWPSCBEAJEK74HK36'</span>
<span class="o">+</span>    <span class="p">)</span>
<span class="o">+</span>
     <span class="k">return</span> <span class="p">(</span>
       <span class="o">&lt;</span><span class="nx">CurrentUserQuery</span> <span class="nx">query</span><span class="o">=</span><span class="p">{</span><span class="nx">GET_CURRENT_USER_QUERY</span><span class="p">}</span><span class="o">&gt;</span>
         <span class="p">{({</span> <span class="nx">loading</span><span class="p">,</span> <span class="nx">data</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="p">@@</span> <span class="o">-</span><span class="mi">58</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">66</span><span class="p">,</span><span class="mi">9</span> <span class="p">@@</span> <span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">Home</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="o">&lt;</span><span class="nx">NavigationScreenProps</span><span class="o">&gt;</span> <span class="p">{</span>
                      <span class="nx">s</span><span class="p">.</span><span class="nx">pa4</span>
                    <span class="p">]}</span>
                  <span class="o">&gt;</span>
<span class="o">-</span>                   <span class="o">&lt;</span><span class="nx">Text</span><span class="o">&gt;</span><span class="nx">$1000</span><span class="o">&lt;</span><span class="sr">/Text</span><span class="err">&gt;
</span><span class="o">+</span>                   <span class="o">&lt;</span><span class="nx">Balance</span>
<span class="o">+</span>                     <span class="nx">accountId</span><span class="o">=</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">me</span><span class="p">.</span><span class="nx">stellarAccount</span><span class="p">}</span>
<span class="o">+</span>                     <span class="nx">asset</span><span class="o">=</span><span class="p">{</span><span class="nx">anchorXUSD</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>                  <span class="o">&lt;</span><span class="sr">/View</span><span class="err">&gt;
</span>                  <span class="o">&lt;</span><span class="nx">View</span><span class="o">&gt;</span>
</code></pre>
<p>After that, you will find the changes in the <code>Home</code> container to use <code>Balance</code>.</p>

<p>If you run the app, you should see the balance in your AnchorX account.</p>

<p>You can see the changes in this section in <a href="https://github.com/abuiles/AnchorX/pull/11">pull request #11</a>.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/0D3Z3n1C2H2V3D321u2H/Screen%20Recording%202018-07-18%20at%2009.28%20PM.gif?X-CloudApp-Visitor-Id=49274&amp;v=780917c0" alt="Screen%20recording%202018 07 18%20at%2009.28%20pm" /></p>
<h2 id='balance-updates'>Balance updates</h2>
<p>You can see your balance noew but if you send or receive USD, the balance won&#39;t update. The horizon server allows you to call some end-points in streaming mode using Server-Sent Events, account details is one of those end-points.</p>

<p>In this chapter you will learn how to use the streaming mode to update the account balance.</p>

<p>In the following GIF you can see how you need to refresh the app to see the balance updated.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/0L3N0S2D223l3K1S3a2r/Screen%20Recording%202018-07-19%20at%2009.44%20AM.gif?X-CloudApp-Visitor-Id=49274&amp;v=e537cac7" alt="Screen%20recording%202018 07 19%20at%2009.44%20am" /></p>
<pre class="highlight javascript"><code><span class="nx">mutation</span> <span class="p">{</span>
  <span class="nx">credit</span><span class="p">(</span><span class="nx">amount</span><span class="p">:</span> <span class="s2">"10"</span><span class="p">,</span> <span class="nx">username</span><span class="p">:</span><span class="s2">"your-username"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">id</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>You can try it by going to <a href="https://anchorx-api.herokuapp.com/">https://anchorx-api.herokuapp.com/</a> and writing the mutation on the right using your username.</p>
<h2 id='using-streaming-mode'>Using streaming mode</h2>
<blockquote>
<p>Edit <code>app/containers/Balance.tsx</code></p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code>   <span class="nx">async</span> <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
     <span class="kr">const</span> <span class="p">{</span> <span class="nx">accountId</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>
     <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">)</span>
     <span class="kr">const</span> <span class="nx">sdkAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">accountId</span><span class="p">)</span>

<span class="o">+</span>    <span class="c1">// Setup streaming to the accountId, this returns a function which</span>
<span class="o">+</span>    <span class="c1">// you can use to close the stream.</span>
<span class="o">+</span>    <span class="kd">let</span> <span class="nx">accountEventsClose</span> <span class="o">=</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">accounts</span><span class="p">().</span><span class="nx">accountId</span><span class="p">(</span><span class="nx">accountId</span><span class="p">).</span><span class="nx">stream</span><span class="p">({</span>
<span class="o">+</span>      <span class="c1">// onmessage is called each time the ledger closes</span>
<span class="o">+</span>      <span class="na">onmessage</span><span class="p">:</span> <span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="o">+</span>        <span class="kr">const</span> <span class="p">{</span> <span class="nx">sdkAccount</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>
<span class="o">+</span>
<span class="o">+</span>        <span class="c1">// Check if balances changed and if they did update sdkAcount.balances</span>
<span class="o">+</span>        <span class="k">if</span> <span class="p">(</span><span class="nx">sdkAccount</span><span class="p">.</span><span class="nx">balances</span> <span class="o">!==</span> <span class="nx">res</span><span class="p">.</span><span class="nx">balances</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>          <span class="nx">sdkAccount</span><span class="p">.</span><span class="nx">balances</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">balances</span>
<span class="o">+</span>
<span class="o">+</span>          <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
<span class="o">+</span>            <span class="na">sdkAccount</span><span class="p">:</span> <span class="nx">sdkAccount</span>
<span class="o">+</span>          <span class="p">})</span>
<span class="o">+</span>        <span class="p">}</span>
<span class="o">+</span>      <span class="p">}</span>
<span class="o">+</span>    <span class="p">});</span>
<span class="o">+</span>
<span class="o">+</span>    <span class="c1">// For convinience add this to the account so you can close</span>
<span class="o">+</span>    <span class="c1">// on componentWillUnmount. hat-tip to StellarTerm ;)</span>
<span class="o">+</span>    <span class="nx">sdkAccount</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="o">+</span>      <span class="k">try</span> <span class="p">{</span>
<span class="o">+</span>        <span class="nx">accountEventsClose</span><span class="p">();</span>
<span class="o">+</span>      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'error closing account streaming'</span><span class="p">)</span>
<span class="o">+</span>      <span class="p">}</span>
<span class="o">+</span>    <span class="p">}</span>
<span class="o">+</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
       <span class="nx">sdkAccount</span>
     <span class="p">})</span>
   <span class="p">}</span>

<span class="o">+</span>  <span class="nx">componentWillUnmount</span><span class="p">()</span> <span class="p">{</span>
<span class="o">+</span>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">sdkAccount</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>
<span class="o">+</span>    <span class="c1">// Close the stream when unmounting the component</span>
<span class="o">+</span>    <span class="nx">sdkAccount</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
<span class="o">+</span>  <span class="p">}</span>
<span class="o">+</span>
   <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
     <span class="kr">const</span> <span class="p">{</span> <span class="nx">sdkAccount</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>
     <span class="kr">const</span> <span class="p">{</span> <span class="nx">asset</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>
<span class="p">}</span>
</code></pre>
<p>The SDK uses the builder pattern to help you interact with horizon and its different functionalities. Once you have an instance of the server, you can setup streaming by calling the following command: <code>stellarServer.accounts().accountId(accountId).stream({args})</code>.</p>

<p>You need to update the lifecycle methods <code>componentDidMount</code> and <code>componentWillUnmount</code> in  <code>app/containers/Balance.tsx</code>. On the right you will find the additions with comments.</p>

<aside class="notice">
You can find the documentation for the account builder <a href="https://stellar.github.io/js-stellar-sdk/AccountCallBuilder.html">here</a>
</aside>

<p>In the GIF below you can see how the balance updates now after using streaming.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/2w3D461n0K3I1M0F2H2J/Screen%20Recording%202018-07-19%20at%2010.59%20AM.gif?X-CloudApp-Visitor-Id=49274&amp;v=cfe8eea8" alt="Screen%20recording%202018 07 19%20at%2010.59%20am" /></p>

<p>You can find the changes in this section in <a href="https://github.com/abuiles/AnchorX/pull/12">pull request #12</a>.</p>

<p>Next, let&#39;s create  display the account payments.</p>
<h2 id='payment-component'>Payment component</h2>
<p>First you need to add a component to display a single payment. If the payment if a debit it will show the message &quot;You paid X&quot; and the value. If you are the receipient, then it shows &quot;X paid you&quot;.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/3K3a1P2l0v1r2X3o2X3A/Screen%20Recording%202018-07-19%20at%2004.55%20PM.gif?X-CloudApp-Visitor-Id=49274&amp;v=b9dca21b" alt="Screen%20recording%202018 07 19%20at%2004.55%20pm" /></p>

<p>The only thing concerning Stellar here is how you can use the TypeScript type to specify that the component will receive a <code>PaymentOperationRecord</code> as part of the props.</p>
<pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="p">{</span> <span class="nx">PaymentOperationRecord</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

<span class="kr">interface</span> <span class="nx">Props</span> <span class="p">{</span>
  <span class="nl">account</span><span class="p">:</span> <span class="nx">string</span>
  <span class="nl">payment</span><span class="p">:</span> <span class="nx">PaymentOperationRecord</span>
<span class="p">}</span>
</code></pre>
<p>You can find the component implementation in <a href="https://github.com/abuiles/AnchorX/pull/13">pull request #13</a>.</p>

<p>Next you&#39;ll write a container to load the payments and use the Payment component for each entry.</p>
<h2 id='showing-payments'>Showing payments</h2>
<blockquote>
<p>Create the file <code>app/containers/Payments.tsx</code> with the following code:</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">View</span><span class="p">,</span> <span class="nx">StyleSheet</span><span class="p">,</span> <span class="nx">FlatList</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-native'</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">Container</span><span class="p">,</span> <span class="nx">Content</span><span class="p">,</span> <span class="nx">Text</span><span class="p">,</span> <span class="nx">Button</span><span class="p">,</span> <span class="nx">Spinner</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'native-base'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">styles</span> <span class="nx">as</span> <span class="nx">s</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-native-style-tachyons'</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">Asset</span><span class="p">,</span> <span class="nx">PaymentOperationRecord</span><span class="p">,</span> <span class="nx">Server</span><span class="p">,</span> <span class="nx">Network</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

<span class="kr">import</span> <span class="nx">Payment</span> <span class="nx">from</span> <span class="s1">'../components/Payment'</span>

<span class="kr">interface</span> <span class="nx">Props</span> <span class="p">{</span>
  <span class="nl">accountId</span><span class="p">:</span> <span class="nx">string</span>
  <span class="nx">asset</span><span class="p">?:</span> <span class="nx">Asset</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">State</span> <span class="p">{</span>
  <span class="nl">loadMore</span><span class="p">:</span> <span class="kr">boolean</span>
  <span class="nl">payments</span><span class="p">:</span> <span class="nx">PaymentOperationRecord</span><span class="p">[]</span>
  <span class="nl">loading</span><span class="p">:</span> <span class="kr">boolean</span>
  <span class="nx">closeStreaming</span><span class="p">?:</span> <span class="nx">any</span>
<span class="p">}</span>


<span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">Payments</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="o">&lt;</span><span class="nx">Props</span><span class="p">,</span> <span class="nx">State</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="na">props</span><span class="p">:</span> <span class="nx">Props</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">loadMore</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">payments</span><span class="p">:</span> <span class="p">[],</span>
      <span class="na">loading</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">async</span> <span class="nx">loadPayments</span><span class="p">(</span><span class="nx">cursor</span><span class="p">?:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">accountId</span><span class="p">,</span> <span class="nx">asset</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">payments</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>
    <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">()</span>
    <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">)</span>

    <span class="c1">// Load payments for account in descending order, most recentfirst.</span>
    <span class="kd">let</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">stellarServer</span>
      <span class="p">.</span><span class="nx">payments</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">forAccount</span><span class="p">(</span><span class="nx">accountId</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">order</span><span class="p">(</span><span class="s1">'desc'</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">cursor</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">cursor</span><span class="p">(</span><span class="nx">cursor</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="p">{</span> <span class="nx">records</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">call</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">asset</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">records</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">payment</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">payment</span><span class="p">.</span><span class="nx">asset_code</span> <span class="o">===</span> <span class="nx">asset</span><span class="p">.</span><span class="nx">code</span> <span class="o">&amp;&amp;</span> <span class="nx">payment</span><span class="p">.</span><span class="nx">asset_issuer</span> <span class="o">===</span> <span class="nx">asset</span><span class="p">.</span><span class="nx">issuer</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">records</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/* Use `now` in the cursor to be notified of new payments. If you don't
   * set the cursor to "now", then you'll be notified about all the
   * payments since account's creation.*/</span>
  <span class="nx">listenForPayments</span><span class="p">(</span><span class="nx">cursor</span> <span class="o">=</span> <span class="s1">'now'</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">closeStreaming</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">closeStreaming</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">closeStreaming</span><span class="p">()</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'error closing streaming'</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="p">{</span> <span class="nx">accountId</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>

    <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">()</span>
    <span class="kr">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">)</span>

    <span class="c1">// Notice how you can use PaymentOperationRecord from @types/stellar-sdk</span>
    <span class="kd">let</span> <span class="nx">handleMessage</span> <span class="o">=</span> <span class="p">(</span><span class="na">payment</span><span class="p">:</span> <span class="nx">PaymentOperationRecord</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="p">{</span> <span class="nx">asset</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>
      <span class="kr">const</span> <span class="p">{</span> <span class="nx">payments</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">payment</span><span class="p">.</span><span class="nx">asset_code</span> <span class="o">===</span> <span class="nx">asset</span><span class="p">.</span><span class="nx">code</span> <span class="o">&amp;&amp;</span> <span class="nx">payment</span><span class="p">.</span><span class="nx">asset_issuer</span> <span class="o">===</span> <span class="nx">asset</span><span class="p">.</span><span class="nx">issuer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
          <span class="na">payments</span><span class="p">:</span> <span class="p">[</span><span class="nx">payment</span><span class="p">,</span> <span class="p">...</span><span class="nx">payments</span><span class="p">]</span>
        <span class="p">})</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
      <span class="na">closeStreaming</span><span class="p">:</span> <span class="nx">server</span><span class="p">.</span><span class="nx">payments</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">cursor</span><span class="p">(</span><span class="nx">cursor</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">forAccount</span><span class="p">(</span><span class="nx">accountId</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">stream</span><span class="p">({</span>
          <span class="na">onmessage</span><span class="p">:</span> <span class="nx">handleMessage</span>
        <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="cm">/* After the component mounts, load the first page of payments and
   * setup streaming*/</span>
  <span class="nx">async</span> <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">payments</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadPayments</span><span class="p">()</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
      <span class="nx">payments</span>
    <span class="p">})</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">listenForPayments</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="nx">componentWillUnmount</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">closeStreaming</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">closeStreaming</span> <span class="o">&amp;&amp;</span> <span class="nx">closeStreaming</span><span class="p">()</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'error closing streaming'</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/* Method use for pagination, it gets calls when the end of the list is
   * reached.  It calls the generic function loadPayments using the last
   * item in payments as the cursor.
   */</span>
  <span class="nx">async</span> <span class="nx">fetchMoreData</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">accountId</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">payments</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>

    <span class="kr">const</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">payments</span><span class="p">[</span><span class="nx">payments</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">id</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
      <span class="na">loading</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">})</span>

    <span class="kr">const</span> <span class="nx">nextPage</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadPayments</span><span class="p">(</span><span class="nx">cursor</span><span class="p">)</span>

    <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">loadMore</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">payments</span><span class="p">:</span> <span class="p">[...</span><span class="nx">payments</span><span class="p">,</span> <span class="p">...</span><span class="nx">nextPage</span><span class="p">],</span>
      <span class="na">loading</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">nextPage</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">state</span><span class="p">.</span><span class="nx">loadMore</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">accountId</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">loadMore</span><span class="p">,</span> <span class="nx">payments</span><span class="p">,</span> <span class="nx">loading</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">Container</span> <span class="nx">style</span><span class="o">=</span><span class="p">{{</span> <span class="na">backgroundColor</span><span class="p">:</span> <span class="s1">'#F5FCFF'</span> <span class="p">}}</span> <span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">FlatList</span>
          <span class="nx">data</span><span class="o">=</span><span class="p">{</span><span class="nx">payments</span><span class="p">}</span>
          <span class="nx">renderItem</span><span class="o">=</span><span class="p">{({</span> <span class="nx">item</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">Payment</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span> <span class="nx">payment</span><span class="o">=</span><span class="p">{</span><span class="nx">item</span><span class="p">}</span> <span class="nx">account</span><span class="o">=</span><span class="p">{</span><span class="nx">accountId</span><span class="p">}</span> <span class="sr">/&gt;</span><span class="err">}
</span>          <span class="nx">keyExtractor</span><span class="o">=</span><span class="p">{(</span><span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
          <span class="nx">onEndReachedThreshold</span><span class="o">=</span><span class="p">{</span><span class="mf">0.2</span><span class="p">}</span>
          <span class="nx">onEndReached</span><span class="o">=</span><span class="p">{({</span> <span class="nx">distanceFromEnd</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">loadMore</span> <span class="o">||</span> <span class="nx">loading</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">fetchMoreData</span><span class="p">()</span>
          <span class="p">}}</span>
          <span class="nx">refreshing</span><span class="o">=</span><span class="p">{</span><span class="nx">loading</span><span class="p">}</span>
          <span class="nx">ListFooterComponent</span><span class="o">=</span><span class="p">{</span><span class="nx">loading</span> <span class="o">&amp;&amp;</span> <span class="o">&lt;</span><span class="nx">Spinner</span> <span class="nx">color</span><span class="o">=</span><span class="s2">"blue"</span> <span class="o">/&gt;</span><span class="p">}</span>
          <span class="nx">onRefresh</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">payments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">listenForPayments</span><span class="p">(</span><span class="nx">payments</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">)</span>
            <span class="p">}</span>
          <span class="p">}}</span>
        <span class="sr">/</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/Container</span><span class="err">&gt;
</span>    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>To show transactions, you will follow a similar pattern to the one use in the previous section. Create a container component which will load the last page of payments using the <a href="https://stellar.github.io/js-stellar-sdk/Server.html#payments">payments method</a> in the Server class. And then use streaming from the <a href="https://stellar.github.io/js-stellar-sdk/PaymentCallBuilder.html">PaymentCallBuilder</a>.</p>

<p>At this point most of the changes are related with React and building components. On the right you can see the component implementation. The following functions use the SDK:</p>

<ul>
<li><code>loadPayments</code>: Sets the server and loads the first page of payments.</li>
<li><code>listenForPayments</code>: Set streaming.</li>
<li><code>fetchMoreData</code>: Call when loading more payments.</li>
</ul>

<p>Also, noticed how you can use types defined in <code>@types/stellar-sdk</code> like <code>PaymentOperationRecord</code>.</p>

<p>After creating the component, you can import it in the Home container and use it by passing the <code>accountId</code> and <code>asset</code>, you can see the change <a href="https://github.com/abuiles/AnchorX/pull/14/files#diff-32a848d19077743a2d26b348315714e3R75">here</a>.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/2N1v02411B0H2y43362n/Screen%20Recording%202018-07-20%20at%2011.06%20AM.gif?X-CloudApp-Visitor-Id=49274&amp;v=de150e07" alt="Screen%20recording%202018 07 20%20at%2011.06%20am" /></p>

<p>You can see the the changes in <a href="https://github.com/abuiles/AnchorX/pull/14/files">pull request #14</a>.</p>
<h2 id='depositing-and-withdrawing-fiat-from-the-wallet'>Depositing and withdrawing fiat from the wallet</h2>
<p>In this section you will add two screens to deposit or withdraw money from AnchorX.</p>

<p>First you need to add a transfer form component which you will reuse for both operations.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/1i2B2R3w2H2t3u1X1N3Q/Screen%20Recording%202018-07-23%20at%2008.02%20AM.gif?X-CloudApp-Visitor-Id=49274&amp;v=b8034496" alt="Screen%20recording%202018 07 23%20at%2008.02%20am" /></p>

<p>In <a href="https://github.com/abuiles/AnchorX/pull/15">pull request #15</a> you can find the implementation for the component displayed in the GIF above. It takes as <code>props</code> a function which call the mutation credit or debit. Next, you will find the implantation for both containers.</p>
<h2 id='deposits'>Deposits</h2>
<blockquote>
<p>The content below belongs to app/containers/Deposit.tsx</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">View</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-native'</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">NavigationScreenProps</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-navigation'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Body</span><span class="p">,</span> <span class="nx">Button</span><span class="p">,</span> <span class="nx">Container</span><span class="p">,</span> <span class="nx">Content</span><span class="p">,</span> <span class="nx">Header</span><span class="p">,</span> <span class="nx">Icon</span><span class="p">,</span> <span class="nx">Left</span><span class="p">,</span> <span class="nx">Right</span><span class="p">,</span> <span class="nx">Text</span><span class="p">,</span> <span class="nx">Title</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'native-base'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">styles</span> <span class="nx">as</span> <span class="nx">s</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-native-style-tachyons'</span>
<span class="kr">import</span> <span class="nx">layoutStyles</span> <span class="nx">from</span> <span class="s1">'../styles/layout'</span>
<span class="kr">import</span> <span class="nx">DismissableStackNavigator</span> <span class="nx">from</span> <span class="s1">'./DismissableStackNavigator'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Transaction</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'../Types'</span>
<span class="kr">import</span> <span class="nx">TransferForm</span> <span class="nx">from</span> <span class="s1">'../components/TransferForm'</span>
<span class="kr">import</span> <span class="nx">CreditDebitMutation</span><span class="p">,</span> <span class="p">{</span> <span class="nx">CREDIT_MUTATION</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'../mutations/CreditDebit'</span>
<span class="kr">import</span> <span class="nx">CurrentUserQuery</span><span class="p">,</span> <span class="p">{</span> <span class="nx">GET_CURRENT_USER_QUERY</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'../queries/CurrentUser'</span>

<span class="kr">export</span> <span class="kr">class</span> <span class="nx">DepositScreen</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="o">&lt;</span><span class="nx">NavigationScreenProps</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nx">async</span> <span class="nx">deposit</span><span class="p">(</span><span class="nx">mutation</span><span class="p">,</span> <span class="na">username</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="na">amount</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Transaction</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">data</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">mutation</span><span class="p">({</span>
      <span class="na">variables</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">username</span><span class="p">,</span>
        <span class="nx">amount</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="nx">data</span><span class="p">.</span><span class="nx">credit</span>
  <span class="p">}</span>

  <span class="nx">didSend</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">navigation</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s1">'Home'</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">navigation</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>

    <span class="kr">const</span> <span class="nx">userSelected</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">navigation</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s1">'PaymentDetails'</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">CurrentUserQuery</span> <span class="nx">query</span><span class="o">=</span><span class="p">{</span><span class="nx">GET_CURRENT_USER_QUERY</span><span class="p">}</span><span class="o">&gt;</span>
        <span class="p">{({</span> <span class="nx">loading</span><span class="p">,</span> <span class="nx">data</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">return</span> <span class="o">&lt;</span><span class="nx">Loading</span> <span class="o">/&gt;</span>
           <span class="p">}</span>

           <span class="kr">const</span> <span class="p">{</span> <span class="nx">me</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">data</span>
           <span class="k">return</span> <span class="p">(</span>
             <span class="o">&lt;</span><span class="nx">Container</span> <span class="nx">style</span><span class="o">=</span><span class="p">{{</span><span class="na">backgroundColor</span><span class="p">:</span> <span class="s1">'#F5FCFF'</span><span class="p">}}</span><span class="o">&gt;</span>
               <span class="o">&lt;</span><span class="nx">Header</span> <span class="nx">style</span><span class="o">=</span><span class="p">{</span><span class="nx">layoutStyles</span><span class="p">.</span><span class="nx">header</span><span class="p">}</span><span class="o">&gt;</span>
                 <span class="o">&lt;</span><span class="nx">Left</span><span class="o">&gt;</span>
                   <span class="o">&lt;</span><span class="nx">Button</span>
                     <span class="nx">transparent</span>
                     <span class="nx">onPress</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">screenProps</span><span class="p">.</span><span class="nx">dismiss</span><span class="p">()}</span><span class="o">&gt;</span>
                     <span class="o">&lt;</span><span class="nx">Icon</span> <span class="nx">name</span><span class="o">=</span><span class="s1">'close'</span> <span class="o">/&gt;</span>
                   <span class="o">&lt;</span><span class="sr">/Button</span><span class="err">&gt;
</span>                 <span class="o">&lt;</span><span class="sr">/Left</span><span class="err">&gt;
</span>                 <span class="o">&lt;</span><span class="nx">Body</span><span class="o">&gt;</span>
                   <span class="o">&lt;</span><span class="nx">Title</span><span class="o">&gt;</span><span class="nx">Deposit</span><span class="o">&lt;</span><span class="sr">/Title</span><span class="err">&gt;
</span>                 <span class="o">&lt;</span><span class="sr">/Body</span><span class="err">&gt;
</span>                 <span class="o">&lt;</span><span class="nx">Right</span> <span class="o">/&gt;</span>
               <span class="o">&lt;</span><span class="sr">/Header</span><span class="err">&gt;
</span>               <span class="o">&lt;</span><span class="nx">Content</span> <span class="nx">scrollEnabled</span><span class="o">=</span><span class="p">{</span><span class="kc">false</span><span class="p">}</span><span class="o">&gt;</span>
                 <span class="o">&lt;</span><span class="nx">CreditDebitMutation</span> <span class="nx">mutation</span><span class="o">=</span><span class="p">{</span><span class="nx">CREDIT_MUTATION</span><span class="p">}</span><span class="o">&gt;</span>
                   <span class="p">{(</span><span class="nx">mutation</span><span class="p">,</span> <span class="p">{</span> <span class="nx">data</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
                      <span class="k">return</span> <span class="p">(</span>
                        <span class="o">&lt;</span><span class="nx">TransferForm</span> <span class="nx">send</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">deposit</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">mutation</span><span class="p">,</span> <span class="nx">me</span><span class="p">.</span><span class="nx">username</span><span class="p">)}</span> <span class="nx">didSend</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">didSend</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)}</span> <span class="sr">/</span><span class="err">&gt;
</span>                      <span class="p">)</span>
                   <span class="p">}}</span>
                 <span class="o">&lt;</span><span class="sr">/CreditDebitMutation</span><span class="err">&gt;
</span>               <span class="o">&lt;</span><span class="sr">/Content</span><span class="err">&gt;
</span>             <span class="o">&lt;</span><span class="sr">/Container</span><span class="err">&gt;
</span>           <span class="p">)</span>
        <span class="p">}}</span>
      <span class="o">&lt;</span><span class="sr">/CurrentUserQuery</span><span class="err">&gt;
</span>    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">DismissableStackNavigator</span><span class="p">(</span>
  <span class="p">{</span>
    <span class="na">Deposit</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">screen</span><span class="p">:</span> <span class="nx">DepositScreen</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">initialRouteName</span><span class="p">:</span> <span class="s1">'Deposit'</span><span class="p">,</span>
    <span class="na">headerMode</span><span class="p">:</span> <span class="s1">'none'</span><span class="p">,</span>
    <span class="na">cardStyle</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">backgroundColor</span><span class="p">:</span> <span class="s1">'#F5FCFF'</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">)</span>
</code></pre>
<p>To deposit money into the account, you will create a new container which will use the deposit mutation and the transfer form. On the right you can see the implementation for such container. For this tutorial, assume your bank account has been linked when you went through signup.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/2n1c1D15440a0D0W3q0S/Screen%20Recording%202018-07-23%20at%2010.09%20AM.gif?X-CloudApp-Visitor-Id=49274&amp;v=57d5f857" alt="Screen%20recording%202018 07 23%20at%2010.09%20am" /></p>

<p><a href="https://github.com/abuiles/AnchorX/pull/16">Pull request #16</a> shows you all the implementation details. The following are some of the relevant changes:</p>

<ul>
<li>Mutation component: <a href="https://github.com/abuiles/AnchorX/pull/16/files#diff-edc1bb1b69c5a2a4ae142da5ad61e9c1">https://github.com/abuiles/AnchorX/pull/16/files#diff-edc1bb1b69c5a2a4ae142da5ad61e9c1</a></li>
<li>Add a new option to the menu bar: <a href="https://github.com/abuiles/AnchorX/pull/16/files#diff-82d98b5838f0e7e19e05fe1a563eb307R34">https://github.com/abuiles/AnchorX/pull/16/files#diff-82d98b5838f0e7e19e05fe1a563eb307R34</a></li>
<li>Extend <code>TransferForm</code> to receive a <code>didSend</code> callback: <a href="https://github.com/abuiles/AnchorX/pull/16/files#diff-76291595d5a283ba48caa79aca053ac0L9">https://github.com/abuiles/AnchorX/pull/16/files#diff-76291595d5a283ba48caa79aca053ac0L9</a></li>
</ul>

<p>Next, you will add the withdrawals container.</p>
<h2 id='withdrawals'>Withdrawals</h2>
<p>Withdrawals are very similar to deposits, the only thing that changes is the mututation used in the callback. Instead of using <code>credit</code> you will use <code>debit</code>.</p>

<p>Since the code is very similar you won&#39;t see it here, instead you can go to Github and check <a href="https://github.com/abuiles/AnchorX/pull/17">pull request #17</a> which includes lal the changes.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/0W3r2g1b2a2C3k0u1R1t/Screen%20Recording%202018-07-23%20at%2010.46%20AM.gif?X-CloudApp-Visitor-Id=49274&amp;v=4c5c7ace" alt="Screen%20recording%202018 07 23%20at%2010.46%20am" /></p>

<p>Next you will implement the final screen which is which will allow you to send money to other AnchorX users, using their <code>username</code>.</p>
<h2 id='sending-payments'>Sending payments</h2>
<p>To send new payments you need to create a payment form and then change the new payment container to render the form. The boilerplate has two screens, the first one is meant to be used for searching the recipient like in Venmo and the second one to input the amount, however, this tutorial won&#39;t include the search part and it would be left as an exercise to the reader as mapping the Stellar address to real usernames in the payments list. The payment form will take the recipient&#39;s username and the amount and then call the payment mutation.</p>
<h2 id='new-payment-form'>New Payment form</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Alert</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'react-native'</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Container</span><span class="p">,</span> <span class="nx">Content</span><span class="p">,</span> <span class="nx">Form</span><span class="p">,</span> <span class="nx">Item</span><span class="p">,</span> <span class="nx">Input</span><span class="p">,</span> <span class="nx">Label</span><span class="p">,</span> <span class="nx">Button</span><span class="p">,</span> <span class="nx">Text</span><span class="p">,</span> <span class="nx">Spinner</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'native-base'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">styles</span> <span class="nx">as</span> <span class="nx">s</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">"react-native-style-tachyons"</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">Transaction</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'../Types'</span>

<span class="kr">interface</span> <span class="nx">Props</span> <span class="p">{</span>
  <span class="nl">send</span><span class="p">:</span> <span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">amount</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Transaction</span><span class="o">&gt;</span>
  <span class="nx">didSend</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">State</span> <span class="p">{</span>
  <span class="nl">amount</span><span class="p">:</span> <span class="nx">string</span>
  <span class="nl">username</span><span class="p">:</span> <span class="nx">string</span>
  <span class="nl">sending</span><span class="p">:</span> <span class="kr">boolean</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">PaymentForm</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="o">&lt;</span><span class="nx">Props</span><span class="p">,</span> <span class="nx">State</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="na">props</span><span class="p">:</span> <span class="nx">Props</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">amount</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="na">username</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="na">sending</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">async</span> <span class="nx">send</span><span class="p">():</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Transaction</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">amount</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
      <span class="na">sending</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">})</span>

    <span class="kr">const</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">amount</span><span class="p">)</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
      <span class="na">sending</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">})</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">didSend</span><span class="p">()</span>

    <span class="k">return</span> <span class="nx">transaction</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">sending</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">Container</span> <span class="nx">style</span><span class="o">=</span><span class="p">{{</span><span class="na">backgroundColor</span><span class="p">:</span> <span class="s1">'#F5FCFF'</span><span class="p">}}</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">Content</span> <span class="nx">scrollEnabled</span><span class="o">=</span><span class="p">{</span><span class="kc">false</span><span class="p">}</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="nx">Form</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">Item</span> <span class="nx">floatingLabel</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">Label</span><span class="o">&gt;</span><span class="nx">Recipient</span> <span class="nx">username</span><span class="o">&lt;</span><span class="sr">/Label</span><span class="err">&gt;
</span>              <span class="o">&lt;</span><span class="nx">Input</span>
                <span class="nx">onChangeText</span><span class="o">=</span><span class="p">{(</span><span class="nx">username</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="nx">username</span> <span class="p">})}</span>
                <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">username</span><span class="p">}</span>
                <span class="nx">autoFocus</span><span class="o">=</span><span class="p">{</span><span class="kc">true</span><span class="p">}</span>
                <span class="nx">autoCorrect</span><span class="o">=</span><span class="p">{</span><span class="kc">false</span><span class="p">}</span>
                <span class="nx">autoCapitalize</span><span class="o">=</span><span class="p">{</span><span class="s2">"none"</span><span class="p">}</span>
              <span class="sr">/</span><span class="err">&gt;
</span>            <span class="o">&lt;</span><span class="sr">/Item</span><span class="err">&gt;
</span>            <span class="o">&lt;</span><span class="nx">Item</span> <span class="nx">floatingLabel</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">Label</span><span class="o">&gt;</span><span class="nx">Amount</span><span class="o">&lt;</span><span class="sr">/Label</span><span class="err">&gt;
</span>              <span class="o">&lt;</span><span class="nx">Input</span>
                <span class="nx">onChangeText</span><span class="o">=</span><span class="p">{(</span><span class="nx">amount</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="nx">amount</span> <span class="p">})}</span>
                <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">amount</span><span class="p">}</span>
                <span class="nx">keyboardType</span><span class="o">=</span><span class="p">{</span><span class="s1">'decimal-pad'</span><span class="p">}</span>
                <span class="nx">autoCorrect</span><span class="o">=</span><span class="p">{</span><span class="kc">false</span><span class="p">}</span>
                <span class="nx">autoCapitalize</span><span class="o">=</span><span class="p">{</span><span class="s2">"none"</span><span class="p">}</span>
              <span class="sr">/</span><span class="err">&gt;
</span>            <span class="o">&lt;</span><span class="sr">/Item</span><span class="err">&gt;
</span>            <span class="p">{</span><span class="o">!</span><span class="nx">sending</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
               <span class="o">&lt;</span><span class="nx">Button</span> <span class="nx">full</span> <span class="nx">style</span><span class="o">=</span><span class="p">{[</span><span class="nx">s</span><span class="p">.</span><span class="nx">mt4</span><span class="p">]}</span> <span class="nx">onPress</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">send</span><span class="p">()}</span><span class="o">&gt;</span>
                 <span class="o">&lt;</span><span class="nx">Text</span><span class="o">&gt;</span><span class="nx">Send</span><span class="o">&lt;</span><span class="sr">/Text</span><span class="err">&gt;
</span>               <span class="o">&lt;</span><span class="sr">/Button</span><span class="err">&gt;
</span>            <span class="p">)}</span>
            <span class="p">{</span><span class="nx">sending</span> <span class="o">&amp;&amp;</span> <span class="o">&lt;</span><span class="nx">Spinner</span> <span class="nx">color</span><span class="o">=</span><span class="s2">"blue"</span> <span class="o">/&gt;</span><span class="p">}</span>
          <span class="o">&lt;</span><span class="sr">/Form</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="sr">/Content</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/Container</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">PaymentForm</span>
</code></pre>
<p>First you need to add a form to send new payments. The code on the right shows you the component used in the GIF below.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/1U3Z1z1B2x2l1J2H3X1C/Screen%20Recording%202018-07-23%20at%2011.19%20AM.gif?X-CloudApp-Visitor-Id=49274&amp;v=cf6755fb" alt="Screen%20recording%202018 07 23%20at%2011.19%20am" /></p>

<p>You can see the implementation in <a href="https://github.com/abuiles/AnchorX/pull/18/files">pull request #18</a>. Next let&#39;s update the new payment container to use the payment form and add a new mutation for payments.</p>
<h2 id='new-payment-container'>New Payment container</h2>
<p>You new to use the payment form component in the new payment container. Also, you need to add a new mutation component for <code>payment</code>. The following GIF shows the functionality working:</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/1D2Y112X0X1t261H1S0P/Screen%20Recording%202018-07-23%20at%2012.10%20PM.gif?X-CloudApp-Visitor-Id=49274&amp;v=ba6f5c5a" alt="Screen%20recording%202018 07 23%20at%2012.10%20pm" /></p>

<p>You can find the changes in <a href="https://github.com/abuiles/AnchorX/pull/19/files">pull request #19</a>. The following are the relevant parts of that PR:</p>

<ul>
<li><code>Mutation</code>: <a href="https://github.com/abuiles/AnchorX/pull/19/files#diff-6b176d09842db5660d3df5ad191d4c67R69">https://github.com/abuiles/AnchorX/pull/19/files#diff-e36e4c2d86d36183ccec7eb4f7090ee4</a></li>
<li><code>PaymentForm</code>: <a href="https://github.com/abuiles/AnchorX/pull/19/files#diff-6b176d09842db5660d3df5ad191d4c67R69">https://github.com/abuiles/AnchorX/pull/19/files#diff-6b176d09842db5660d3df5ad191d4c67R69</a></li>
</ul>
<h2 id='conclusion-2'>Conclusion</h2>
<p>Now you have a basic clone of Venmo using Stellar. In this section you learned how to build a mobile wallet using the JS Stellar SDK in React Native and how to use to do things like read an  account from the ledger or use streaming. There are many more features that could be build but they will be left as an exercise to the reader. For example, you could add a resolver which takes a Stellar account and returns the username associated with that account.</p>

<p>As mentioned at the beginning of this tutorial, AnchorX takes a different approach to other anchors since it manages users account. You could try modifying this wallet to allow each user to manage their own private keys and then use AnchorX to resolver usernames to Stellar addresses.</p>

<p>Before finishing the tutorial, you will learn about some best practices around account management and security.</p>
<h1 id='best-practices'>Best practices</h1><h2 id='using-multisignature'>Using multisignature</h2>
<p>Transactions in Stellar need an authorization to be valid. Such
authorization is signed by the public key associated with the
account. However, Stellar allows you to add multiple signers to an
account and then specify a security level which can be <code>low</code>, <code>medium</code> or
<code>high</code>. Each level has the following features:</p>

<ul>
<li><p><code>low</code>: it allows to update the sequence number for the source account and the allow trust operation.</p></li>
<li><p><code>medium</code>: all other operations listed <a href="https://www.stellar.org/developers/guides/concepts/list-of-operations.html">here</a></p></li>
<li><p><code>high</code>: it allows signers or the thresholds update and merge account operation.</p></li>
</ul>

<p>The official documentation has a completed summary on multisignature
<a href="https://www.stellar.org/developers/guides/concepts/multi-sig.html">https://www.stellar.org/developers/guides/concepts/multi-sig.html</a>
- please give it a read before continuing.</p>
<pre class="highlight plaintext"><code>  const signerKeys = Keypair.fromSecret(
    // Use something like KMS in production
    AES.decrypt(
      sender.stellarSeed,
      ENVCryptoSecret
    ).toString(enc.Utf8)
  )
</code></pre>
<p>You can use multisignature to create different security schemas around
account management, if you recall, you were decrypting the seed for
processing new payments like displayed in the right. The issue with
this is that you have to manage all your user keys and then if one
gets exposed then you lose control of the account.</p>

<p>An alternative setting instead of using the master key as signer, is
to add two more signers to each account with mid and high threshold,
and change the master key to have a low threshold. With this you will
have the key with the highest threshold always offline and put the
mid-threshold key in a service which can not be easily compromised. The downside of doing this is that it that it will increate the minium balance per account.</p>

<p>This kind of schema was recently used by
<a href="https://satoshipay.io/">SatoshiPay</a> in their Lumens give away, they
were giving away lumens but you could only use them to pay creators in
their platform. To force this, they put a multisignature schema in each
account so if you were trying to send lumens to someone who was not a creator, they would not sign the transaction.</p>

<p>Let&#39;s look next at the code to implement multisignature.</p>
<h2 id='adding-signers-to-an-account'>Adding signers to an account</h2><pre class="highlight javascript tab-javascript"><code><span class="nx">async</span> <span class="kd">function</span> <span class="nx">addSigners</span><span class="p">(</span><span class="nx">keypair</span><span class="p">:</span> <span class="nx">Keypair</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">);</span>

  <span class="kr">const</span> <span class="nx">paymentsId</span> <span class="o">=</span> <span class="s1">'GCQOZGXMH6MI3JKWWO365BCXUJN6MFZR7XMKKCHGDY2K6JNCYFRH6M4C'</span>
  <span class="kr">const</span> <span class="nx">adminId</span> <span class="o">=</span> <span class="s1">'GA6KTSHWU6GX6ER6HTWMGONS4VLQ4ZHONU6RKBGXTT7HFLV6NHX3ONAL'</span>

  <span class="kr">const</span> <span class="nx">account</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">newAccountKeypair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>

  <span class="kd">var</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
      <span class="nx">Operation</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">({</span>
        <span class="na">signer</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">ed25519PublicKey</span><span class="p">:</span> <span class="nx">paymentsId</span><span class="p">,</span>
          <span class="na">weight</span><span class="p">:</span> <span class="mi">2</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">)</span>
    <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
      <span class="nx">Operation</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">({</span>
        <span class="na">signer</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">ed25519PublicKey</span><span class="p">:</span> <span class="nx">adminId</span><span class="p">,</span>
          <span class="na">weight</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">}</span>
      <span class="p">}))</span>
    <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
      <span class="nx">Operation</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">({</span>
        <span class="na">masterWeight</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// set master key weight to 0, it can't do anything</span>
        <span class="na">lowThreshold</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="na">medThreshold</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="c1">// Allows  paymentsId to send payments</span>
        <span class="na">highThreshold</span><span class="p">:</span> <span class="mi">5</span> <span class="c1">// Allows adminId to manage account</span>
      <span class="p">}))</span>
    <span class="p">.</span><span class="nx">build</span><span class="p">();</span>

  <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">keypair</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">server</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">)</span>

<span class="p">}</span>
</code></pre>
<p>Let&#39;s assume you want to use account
<code>GCQOZGXMH6MI3JKWWO365BCXUJN6MFZR7XMKKCHGDY2K6JNCYFRH6M4C</code> for signing
payments and account
<code>GA6KTSHWU6GX6ER6HTWMGONS4VLQ4ZHONU6RKBGXTT7HFLV6NHX3ONAL</code> to be the
admin of all your users accunts.</p>

<p>You will have to call the code on the right after creating the account
in the ledger to change the signers schema.</p>

<p><a href="https://github.com/abuiles/anchorx-api/pull/14">Pull request #14</a> shows you how to apply the multisignature schema above to anchorx-api.</p>
<h2 id='managing-the-issuing-account'>Managing the issuing account</h2>
<p>After issuing AnchorX&#39;s custom asset, you continue using the issuing
account to create and authorize who could hold your asset. There is a
security risk involved with this since if the issuing account gets
compromised the attackers can create as many USD as they want.</p>

<p>To manage this, you can follow the recommendation
<a href="https://www.stellar.org/developers/guides/anchor/index.html#account-structure">here</a>
which is to maintain two accounts, one for issuing and destroying
assets and then a base account which will hold a huge amount of
your asset so it can credit people who transfer USD from their bank
account to their AnchorX account. That way you can keep the secret key
for the issuing account offline.</p>

<p>Additionally, since you need the <code>allowTrust</code> operation, the you can
add a signer with low threshold to the issuing account.</p>
<h2 id='stellar-core-and-horizon'>Stellar Core and Horizon</h2>
<p>For testing purposes it&#39;s fine to relay on the public test network run
by the SDF, however if you are building your own service, you should
be running your own nodes and horizon instance. You can learn more
about it in the <a href="https://www.stellar.org/developers/guides/get-started/index.html">getting started
guide</a>.</p>
<h1 id='conclusion-3'>Conclusion</h1>
<p>As mentioned at the beginning of the tutorial, the goal here was to
show you a different approach to creating an anchor and at the same
time help you get familiar with some concepts in Stellar. Don&#39;t take
what I say here as written in stone, the requirements might be
different for your particular situation, always do your
research. There are other resources out there where you can go and ask
questions like the <a href="https://slack.stellar.org/">Stellar community
Slack</a> and the <a href="https://stellar.stackexchange.com/">Stellar Stack
Exchange</a>. If there is something
else you would like me to write about please let me know. I&#39;m looking
forward to writing more about Stellar and helping you build awesome
stuff on top of it.</p>

<p>--Fin</p>

<aside class="notice">
If you enjoy this tutorial, tweet or tell your friends about it and if
you want to support my writings, you can send XLM donations to the
following Stellar address GBCFAMVYPJTXHVWRFP7VO6F4QE7B4UHAVJOEG5VR6VEB5M67GHQGEEAB
</aside>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="javascript">javascript</a>
          </div>
      </div>
    </div>
  </body>
</html>
