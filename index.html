
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Building your own Venmo with Stellar</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-32360357-1', 'auto');
      ga('send', 'pageview');
      $(document).ready(function() {
        $('.toc-link').on('click', function(){
          ga('send', 'pageview', {
            page: location.pathname + location.search  + location.hash
          });
        });
      });
    </script>
  </head>

  <body class="index" data-languages="[&quot;javascript&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo.png" class="logo" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="javascript">javascript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc" class="toc-list-h1">
          <li>
            <a href="#building-your-own-venmo-with-stellar" class="toc-h1 toc-link" data-title="building-your-own-venmo-with-stellar">Building your own Venmo with Stellar</a>
          </li>
          <li>
            <a href="#concepts" class="toc-h1 toc-link" data-title="concepts">Concepts</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#account" class="toc-h2 toc-link" data-title="account">Account</a>
                  </li>
                  <li>
                    <a href="#assets" class="toc-h2 toc-link" data-title="assets">Assets</a>
                  </li>
                  <li>
                    <a href="#anchor" class="toc-h2 toc-link" data-title="anchor">Anchor</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#anchor-setup" class="toc-h1 toc-link" data-title="anchor-setup">Anchor Setup</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#download-the-app-and-create-an-user" class="toc-h2 toc-link" data-title="download-the-app-and-create-an-user">Download the app and create an user.</a>
                  </li>
                  <li>
                    <a href="#go-through-kyc" class="toc-h2 toc-link" data-title="go-through-kyc">Go through KYC</a>
                  </li>
                  <li>
                    <a href="#credit-from-bank-account" class="toc-h2 toc-link" data-title="credit-from-bank-account">Credit from bank account</a>
                  </li>
                  <li>
                    <a href="#p2p-payments" class="toc-h2 toc-link" data-title="p2p-payments">P2P payments</a>
                  </li>
                  <li>
                    <a href="#transfer-balance-from-anchorx-to-bank-account" class="toc-h2 toc-link" data-title="transfer-balance-from-anchorx-to-bank-account">Transfer balance from AnchorX to Bank account</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#building-the-backend" class="toc-h1 toc-link" data-title="building-the-backend">Building the backend</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#setting-up-the-server" class="toc-h2 toc-link" data-title="setting-up-the-server">Setting up the server</a>
                  </li>
                  <li>
                    <a href="#user-model" class="toc-h2 toc-link" data-title="user-model">User model</a>
                  </li>
                  <li>
                    <a href="#user-signup-mutation" class="toc-h2 toc-link" data-title="user-signup-mutation">User signup mutation</a>
                  </li>
                  <li>
                    <a href="#assigning-a-stellar-account-to-new-users" class="toc-h2 toc-link" data-title="assigning-a-stellar-account-to-new-users">Assigning a Stellar account to new users</a>
                  </li>
                  <li>
                    <a href="#encrypting-the-seed" class="toc-h2 toc-link" data-title="encrypting-the-seed">Encrypting the seed</a>
                  </li>
                  <li>
                    <a href="#testing" class="toc-h2 toc-link" data-title="testing">Testing</a>
                  </li>
                  <li>
                    <a href="#creating-the-account-in-the-stellar-ledger" class="toc-h2 toc-link" data-title="creating-the-account-in-the-stellar-ledger">Creating the account in the Stellar ledger</a>
                  </li>
                  <li>
                    <a href="#payments" class="toc-h2 toc-link" data-title="payments">Payments</a>
                  </li>
                  <li>
                    <a href="#issuing-anchorx-custom-asset" class="toc-h2 toc-link" data-title="issuing-anchorx-custom-asset">Issuing AnchorX custom asset</a>
                  </li>
                  <li>
                    <a href="#setting-up-issuing-account" class="toc-h2 toc-link" data-title="setting-up-issuing-account">Setting up issuing account</a>
                  </li>
                  <li>
                    <a href="#creating-a-trustline" class="toc-h2 toc-link" data-title="creating-a-trustline">Creating a trustline</a>
                  </li>
                  <li>
                    <a href="#allow-trustline" class="toc-h2 toc-link" data-title="allow-trustline">Allow trustline</a>
                  </li>
                  <li>
                    <a href="#welcome-balance" class="toc-h2 toc-link" data-title="welcome-balance">Welcome balance</a>
                  </li>
                  <li>
                    <a href="#paying-with-usd" class="toc-h2 toc-link" data-title="paying-with-usd">Paying with USD</a>
                  </li>
                  <li>
                    <a href="#credit-account" class="toc-h2 toc-link" data-title="credit-account">Credit account</a>
                  </li>
                  <li>
                    <a href="#debit-account" class="toc-h2 toc-link" data-title="debit-account">Debit account</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#building-the-mobile-wallet" class="toc-h1 toc-link" data-title="building-the-mobile-wallet">Building the mobile wallet</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#using-the-stellar-sdk-in-react-native" class="toc-h2 toc-link" data-title="using-the-stellar-sdk-in-react-native">Using the Stellar-SDK in React-Native</a>
                  </li>
                  <li>
                    <a href="#creating-an-user-signup-flow" class="toc-h2 toc-link" data-title="creating-an-user-signup-flow">Creating an user signup flow</a>
                  </li>
                  <li>
                    <a href="#depositing-quot-fiat-quot-into-your-wallet" class="toc-h2 toc-link" data-title="depositing-fiat-into-your-wallet">Depositing "fiat" into your wallet</a>
                  </li>
                  <li>
                    <a href="#showing-account-transactions" class="toc-h2 toc-link" data-title="showing-account-transactions">Showing account transactions</a>
                  </li>
                  <li>
                    <a href="#sending-payments" class="toc-h2 toc-link" data-title="sending-payments">Sending payments</a>
                  </li>
                  <li>
                    <a href="#cashing-out" class="toc-h2 toc-link" data-title="cashing-out">Cashing out</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#security" class="toc-h1 toc-link" data-title="security">Security</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#infrastructure" class="toc-h2 toc-link" data-title="infrastructure">Infrastructure</a>
                  </li>
                  <li>
                    <a href="#keeping-keys-secure" class="toc-h2 toc-link" data-title="keeping-keys-secure">Keeping keys secure</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#f-a-q" class="toc-h1 toc-link" data-title="f-a-q">F.A.Q</a>
          </li>
      </div>
        <ul class="toc-footer">
            <li><a href='https://twitter.com/abuiles'>Follow me on Twitter @abuiles</a></li>
            <li><a href='https://blog.abuiles.com/consulting'>Stellar consulting</a></li>
            <li><a href='https://github.com/abuiles/building-your-own-venmo-with-stellar/issues'>Report issues</a></li>
            <li><a href='https://github.com/lord/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='building-your-own-venmo-with-stellar'>Building your own Venmo with Stellar</h1>
<aside class="notice">
Work in progress - ██████░░░░░░░ 48% complete.
</aside>

<blockquote>
<p>This is a free tutorial, but I like to drink coffee while I write. You can buy my a coffee with XLM, send a tip here <code>GBCFAMVYPJTXHVWRFP7VO6F4QE7B4UHAVJOEG5VR6VEB5M67GHQGEEAB</code> with the memo <code>coffee</code>.</p>
</blockquote>

<p>Welcome to building your own Venmo with Stellar. This guide will show
you how to create a product &quot;similar&quot; to Venmo using Stellar.</p>

<p>In Stellar, an entity like Venmo is called an <code>anchor</code>. When you are building an anchor, there are two suggested ways to build and maintain customer accounts:</p>

<ol>
<li>Maintain a Stellar account for each customer.</li>
<li>Maintain a single Stellar account to transact on behalf of your customers and use the memo field to identify who is the recipient of each transaction.</li>
</ol>

<p>The <a href="https://www.stellar.org/developers/guides/anchor/index.html#customer-accounts">official documentation</a> covers the second method but there is no documentation about the first one.</p>

<p>In this tutorial you will use Stellar to build a low-cost financial service similar to Venmo and instead of following the approach number two which is already documented in the Stellar website, you&#39;ll be maintaining a Stellar account for each customer and also making it transparant to the final user that they are using Stellar.</p>

<p>The following are some of the goals in this tutorial:</p>

<ol>
<li>The final user won&#39;t know about Stellar.</li>
<li>The final user won&#39;t need to store or worry about seed keys.</li>
<li>The final user won&#39;t transact with Lumens.</li>
<li>The system will use Lumens as &quot;usage tokens&quot;. Each account needs Lumens to be able to use the Stellar ledger.</li>
<li>The final user will be depositing &quot;fiat&quot; into the financial instituion and getting &quot;fiat&quot; credited in their accounts.</li>
<li>The final user will hold an asset which represents American Dollars.</li>
<li>All the examples and the wallet will be running in the Stellar testnet.</li>
</ol>

<aside class="notice">
Anchors are entities that people trust to hold their deposits and issue credits into the Stellar network for those deposits.
</aside>
<h1 id='concepts'>Concepts</h1>
<p>Before getting started you need to learn some concepts in Stellar like account, asset, anchor, multisignature.</p>
<h2 id='account'>Account</h2>
<p>The most important unit in Stellar are the accounts. You need to
create one before interacting with the network. To create an account
you need to deposit Lumens into it, you can get the Lumens buying them
in a exchange or asking a friend for some.</p>

<p>When you create an account, you get a public and private key. The
public key is the equivalent of your bank account number and then the
private key is the password. The private key is required to sign each
transaction.</p>

<p>For this tutorial, you&#39;ll be using accounts to create new assets and
also provision other users accounts as they signup for this Venmo
clone which will be called <code>AnchorX</code>. Although each user will have a Stellar account they won&#39;t know
about it.</p>
<h3 id='creating-accounts-in-the-test-network'>Creating accounts in the test network</h3><pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">StellarSdk</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'stellar-sdk'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-fetch'</span><span class="p">)</span>

<span class="c1">// Generates a keypair and funds account with friendbot</span>
<span class="nx">async</span> <span class="kd">function</span> <span class="nx">createAccount</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">pair</span> <span class="o">=</span> <span class="nx">StellarSdk</span><span class="p">.</span><span class="nx">Keypair</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Requesting Lumens'</span><span class="p">)</span>

  <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s2">`https://horizon-testnet.stellar.org/friendbot?addr=</span><span class="p">${</span><span class="nx">pair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">pair</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">pair</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">createAccount</span><span class="p">()</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`
    Congrats, you have a Stellar account in the test network!
    seed: </span><span class="p">${</span><span class="nx">pair</span><span class="p">.</span><span class="nx">secret</span><span class="p">()}</span><span class="s2">
    id: </span><span class="p">${</span><span class="nx">pair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">()}</span><span class="s2">
  `</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`https://horizon-testnet.stellar.org/accounts/</span><span class="p">${</span><span class="nx">pair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">()}</span><span class="s2">`</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`
    Loading account from test network:
    </span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">
  `</span><span class="p">)</span>

  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">run</span><span class="p">()</span>
</code></pre>
<blockquote>
<p>Run it on repl.it <a href="https://repl.it/@abuiles/CreateStellarAccount">https://repl.it/@abuiles/CreateStellarAccount</a></p>
</blockquote>

<p>On the right you can see how to generate a <code>keypair</code> with the <code>Stellar JS SDK</code> and then ask a service run by the Stellar Development Foundation called <code>friendbot</code> to give us some initial Lumens.</p>
<h2 id='assets'>Assets</h2><pre class="highlight json tab-json"><code><span class="err">//</span><span class="w"> </span><span class="err">https</span><span class="p">:</span><span class="err">//horizon.stellar.org/accounts/GBCFAMVYPJTXHVWRFP</span><span class="mi">7</span><span class="err">VO</span><span class="mi">6</span><span class="err">F</span><span class="mi">4</span><span class="err">QE</span><span class="mi">7</span><span class="err">B</span><span class="mi">4</span><span class="err">UHAVJOEG</span><span class="mi">5</span><span class="err">VR</span><span class="mi">6</span><span class="err">VEB</span><span class="mi">5</span><span class="err">M</span><span class="mi">67</span><span class="err">GHQGEEAB</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GBCFAMVYPJTXHVWRFP7VO6F4QE7B4UHAVJOEG5VR6VEB5M67GHQGEEAB"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"account_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GBCFAMVYPJTXHVWRFP7VO6F4QE7B4UHAVJOEG5VR6VEB5M67GHQGEEAB"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"balances"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"balance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0000000"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"limit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"922337203685.4775807"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"credit_alphanum4"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MOBI"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_issuer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GA6HCMBLTZS5VYYBCATRBRZ3BZJMAFUDKYYF6AH6MVCMGWMRDNSWJPIH"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"balance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0000000"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"limit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"922337203685.4775807"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"credit_alphanum4"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EURT"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_issuer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GAP5LETOV6YIE62YAM56STDANPRDO7ZFDBGSNHJQIYGGKSMOZAHOOS2S"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"balance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0000000"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"limit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"922337203685.4775807"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"credit_alphanum4"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ETH"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_issuer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GBDEVU63Y6NTHJQQZIKVTC23NWLQVP3WJ2RI2OTSJTNYOIGICST6DUXR"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"balance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0000000"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"limit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"922337203685.4775807"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"credit_alphanum4"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"USD"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_issuer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GBSTRH4QOTWNSVA6E4HFERETX4ZLSR3CIUBLK7AXYII277PFJC4BBYOG"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"balance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"57.9899400"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"asset_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"native"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>The Stellar network allows us to represent any kind of asset. All assets
in Stellar can be traded and exchanged with each other.</p>

<p>Like other protocols, Stellar has a native asset which is called the
<code>Lumen</code> represented with the symbol <code>XLM</code>. Stellar accounts can hold
multiple assets as long as they trust the asset and in some
cases they have been authorized to hold the asset.</p>

<p>Any account can create their own asset representing traditional or custom (work/usage/hybrid) of assets.</p>

<p>Traditional assets are a cryptographic representation of things like
fiat, equity, real estate, goats, you name it.</p>

<p>Lumens are an example of a custom asset or token, at they allow us to
interact with the Stellar network. There are many other types of
assets built on top of Stellar, one example is the <code>EURT</code> which is a
representation of the <code>EURO</code> and allows people to do cross-border
remittances without incurring in high transaction fees. There is also
<code>MOBI</code> which allows people to use the <code>Mobius network</code>, if you hold <code>MOBI</code> then
your can interact with the applications in their network.</p>

<p>On the right you can see the JSON representation of a Stellar
account. Each account has a key called balances, representing the
assets held by the account.</p>

<p>The account on the right has the following assets:</p>

<ul>
<li>MOBI: Asset issued by <a href="https://mobius.network/">Mobius network</a></li>
<li>EURT: Asset issued by <a href="http://tempo.eu.com/">Tempo</a> a remittances company.</li>
<li>ETH: This asset represents Ether, you send real <code>ETH</code> to <a href="http://papaya.io/">http://papaya.io/</a> and they credit you with their <code>ETH</code> asset in your Stellar account.</li>
<li>USD: Asset representing <code>Dollars</code>, issued by <a href="https://stronghold.co/">Stronghold</a>.</li>
<li>native: Native asset of the network, it represents <code>Lumens</code>.</li>
</ul>

<p>Assets in Stellar are representet by a combination of <code>code</code> and <code>issuer</code>. It is possible then to find two assets with the code <code>USD</code> representing Dollars but one can be issued by Bank Of America and the other by Venmo.</p>

<p>It is also possible to find multiple assets with the code <code>BTC</code>, where one
can be backed by <a href="http://papaya.io/">http://papaya.io/</a> and the other
one from <a href="https://stronghold.co/">StrongHold</a>. It means that at some
point the issuer (also known as anchor) received <code>BTC</code> in their
Bitcoin wallets and then credited with their equivalent representation
of Bitcoin your Stellar account. If you visit the following site, <a href="https://stellar.expert/explorer/public/asset">https://stellar.expert/explorer/public/asset</a> you&#39;ll find all the assets issued in Stellar.</p>

<p>You&#39;ll be creating a custom asset in the test network
(testnet) representing Dollars and you will build a way to credit and
debit accounts as if we were depositing Dollars.</p>

<p>You can learn more about assets in the SDF guides: <a href="https://www.stellar.org/developers/guides/concepts/assets.html">https://www.stellar.org/developers/guides/concepts/assets.html</a></p>
<h2 id='anchor'>Anchor</h2>
<p>At the beginning of this tutorial, you read that an entity like
Venmo is called an anchor.  Anchors issue assets on top of Stellar and
then credit those asset to other Stellar accounts. If the anchor
represents fiat, then it is likely an authorized entity to deal with
money like banks, savings and credit institutions or a
remittance company. User deposit fiat to the anchor&#39;s account and they
credit the user Stellar account with the equivalent balance.</p>

<p>This is how banks or Venmo works but instead of using a public ledger
like Stellar, they have their own private system and use third parties
like ACH or SWIFT to move money around.</p>

<p>Anchors can represent also other cryptocurrencies. <a href="https://apay.io/">Papaya</a> is an anchor which includes support for cryptocurrencies like <code>ETH</code>, <code>BTC</code> and others.</p>

<p>If you want to deposit Ether, they give you an Ethereum address. After you deposit Ether to that address they issue the equivalent to your Stellar account. In this case you&#39;ll have to trust Papaya because they&#39;ll be acting as custodian for the Ether you sent them.</p>

<p>In this tutorial, you will be creating an anchor which will issue an
asset representing USD. User will have to download an app, you&#39;ll fake a
KYC process and then create a Stellar account for the user and
authorize the user to hold the asset. Once the user have been
authorized they will be able to deposit USD or debit USD from their accounts.</p>

<p>You can learn more about anchors in the SDF guides: <a href="https://www.stellar.org/developers/guides/anchor/">https://www.stellar.org/developers/guides/anchor/</a></p>
<h1 id='anchor-setup'>Anchor Setup</h1>
<p>The following is high level overview of what happens when you want to use Venmo:</p>

<ol>
<li>Download the app and create an user.</li>
<li>Go through KYC with phone number, email and bank account verification.</li>
<li>Once you are authorized to use Venmo, transfer money from your bank account and send it to other Venmo users.</li>
<li>Transfer to your bank whatever balance you have left.</li>
</ol>

<p>Let&#39;s translate the steps above to actions in AnchorX and then identify the requirements to setup the anchor.</p>
<h3 id='download-the-app-and-create-an-user'>Download the app and create an user.</h3>
<p>Users should be able to download an app and then create an account. To
keep things simple, I&#39;ll be using React-Native with Expo and then use
a username (no password) as sign-up method.</p>
<h3 id='go-through-kyc'>Go through KYC</h3>
<p>In Venmo there is some level of KYC, since this is a toy example we
won&#39;t be including any formal KYC process. By default every user will
be marked as verified. In real life, you probably want to collect user
data like SSN, driver&#39;s license, passport, proof of residence, etc.</p>

<p>After an user creates an account with AnchorX, the service will
automatically provision a Stellar account and authorize the account to
hold the anchor&#39;s asset.</p>

<p>When a Stellar accounts decides to trust a given asset, they are
creating a trustline between the account and the asset. Such operation
has to be stored in the ledger. The code in the right shows a transaction creating a trustline between an <code>account</code> and an <code>asset</code>.</p>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">asset</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StellarSdk</span><span class="p">.</span><span class="nx">Asset</span><span class="p">(</span>
  <span class="s1">'USD'</span><span class="p">,</span>
  <span class="s1">'issuer-id'</span>
<span class="p">);</span>

<span class="k">new</span> <span class="nx">StellarSdk</span>
  <span class="p">.</span><span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">myAccount</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
    <span class="nx">StellarSdk</span><span class="p">.</span><span class="nx">Operation</span><span class="p">.</span><span class="nx">changeTrust</span><span class="p">({</span>
      <span class="nx">asset</span>
    <span class="p">}))</span>
  <span class="p">.</span><span class="nx">build</span><span class="p">();</span>
</code></pre>
<p>Likewise, when the asset issuer requires authorization by them before people can hold their asset. It needs to happen in an operation.
The code shows an operation where the issuing account is authorizing a <code>trustor</code> to hold its asset with code <code>USD</code>.</p>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">trustor</span> <span class="o">=</span> <span class="s1">'some-stellar-address'</span>

<span class="k">new</span> <span class="nx">StellarSdk</span><span class="p">.</span><span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">issuingAccount</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
    <span class="nx">StellarSdk</span><span class="p">.</span><span class="nx">Operation</span><span class="p">.</span><span class="nx">allowTrust</span><span class="p">({</span>
      <span class="nx">trustor</span><span class="p">,</span>
      <span class="na">assetCode</span><span class="p">:</span> <span class="s1">'USD'</span><span class="p">,</span>
      <span class="na">authorize</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">})</span>
  <span class="p">)</span>
  <span class="p">.</span><span class="nx">build</span><span class="p">();</span>
</code></pre>
<p>For this example, <code>AnchorX</code> will be running both operations to allow accounts to transact with its asset.</p>
<h3 id='credit-from-bank-account'>Credit from bank account</h3>
<p>The app will have a section which will simulate transferring from your bank account.</p>
<h3 id='p2p-payments'>P2P payments</h3>
<p>Once the account has been provisioned and have some Dollars, users should be able to send money to other users in AnchorX</p>
<h3 id='transfer-balance-from-anchorx-to-bank-account'>Transfer balance from AnchorX to Bank account</h3>
<p>The app will have a section for depositing their dollars to their bank account.</p>
<h1 id='building-the-backend'>Building the backend</h1>
<p>In this section, you&#39;ll be implementing a GraphQL API which will support user sign-up and sign-in, deposits, withdrawals and payments. The mobile application will be interacting with this API.</p>

<p>The server will be written in <code>TypeScript</code> and use <a href="https://www.prisma.io/">Prisma</a> to generate the user management API.</p>
<h2 id='setting-up-the-server'>Setting up the server</h2>
<p>In this section you can find a GraphQL server created with <a href="https://oss.prisma.io/content/graphql-cli/01-overview">GraphQL CLI</a> and using the <code>TypeScript</code> template. To make things easy there is a release which you can use as starting point.</p>

<p>The following pull request contains the boostrapping step <a href="https://github.com/abuiles/anchorx-api/pull/1">https://github.com/abuiles/anchorx-api/pull/1</a>. You can get it by running the following commands:</p>

<ol>
<li><code>git clone https://github.com/abuiles/anchorx-api</code></li>
<li><code>cd anchorx-api</code></li>
<li><code>git checkout v1</code></li>
</ol>

<p>Next you are going to add the user model.</p>
<h2 id='user-model'>User model</h2>
<p>The user model is defined in <code>database/datamodel.graphql</code>. Users in AnchorX signup using their username. After they signup, the service assigns automatically a Stellar account. The code on the right is the prisma representaion for the user model.</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">type</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="nl">id</span><span class="p">:</span> <span class="nx">ID</span><span class="o">!</span> <span class="p">@</span><span class="nd">unique</span>
  <span class="nx">username</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span> <span class="p">@</span><span class="nd">unique</span>
  <span class="nx">stellarAccount</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span>
  <span class="nx">stellarSeed</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span>
<span class="p">}</span>
</code></pre>
<p>After adding the user model definition to <code>database/datamodel.graphql</code>, you have to run <code>yarn prisma deploy</code> to create a new table in the database and get the CRUD end-points for users.</p>

<p>The <a href="https://github.com/abuiles/anchorx-api/pull/2">pull request #2</a>, shows the changes added in this step. The important changes are <a href="https://github.com/abuiles/anchorx-api/pull/2/files#diff-5ca8cc3ddf0d92dda0872ee778220e21">https://github.com/abuiles/anchorx-api/pull/2/files#diff-5ca8cc3ddf0d92dda0872ee778220e21</a>, the rest is code generated by prisma.</p>

<p>Next you need to add a GraphQL mutation to support user signup. After a new user is created, you need to provision a Stellar account. Provisioning a new account requires multiple steps:</p>

<ol>
<li>Create a public and private key pair.</li>
<li>After the public key has been created, fund that account with some Lumens.</li>
<li>After the account has been created in the Stellar ledger, create a trustline with the anchor asset.</li>
</ol>
<h2 id='user-signup-mutation'>User signup mutation</h2>
<blockquote>
<p>Edit src/schema.graphql to define the schema</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="err">#</span> <span class="kr">import</span> <span class="nx">User</span> <span class="nx">from</span> <span class="s1">'./generated/prisma.graphql'</span>

<span class="nx">type</span> <span class="nx">Query</span> <span class="p">{</span>
  <span class="nx">user</span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span><span class="p">):</span> <span class="nx">User</span>
<span class="p">}</span>

<span class="nx">type</span> <span class="nx">Mutation</span> <span class="p">{</span>
  <span class="nx">signup</span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="nb">String</span><span class="o">!</span><span class="p">):</span> <span class="nx">User</span><span class="o">!</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Define the resolvers and query in <code>src/index.ts</code>. <a href="https://github.com/abuiles/anchorx-api/commit/5d6e9155d42c8e07c4c08bb627fdb48613d67e53">Commit 5d6e91</a> shows the changes in the <code>Mutation</code> and <a href="https://github.com/abuiles/anchorx-api/commit/3d3ffffeec77f1e69965d014989379f733b1d65b">commit 3d3fff</a> shows the changes in the <code>Query</code></p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">Query</span><span class="p">:</span> <span class="p">{</span>
    <span class="nx">user</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">},</span> <span class="na">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">user</span><span class="p">(</span>
        <span class="p">{</span>
          <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
            <span class="nx">username</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">info</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">Mutation</span><span class="p">:</span> <span class="p">{</span>
    <span class="nx">signup</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">},</span> <span class="na">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">username</span><span class="p">,</span>
        <span class="na">stellarAccount</span><span class="p">:</span> <span class="s1">'1234'</span><span class="p">,</span>
        <span class="na">stellarSeed</span><span class="p">:</span> <span class="s1">'1234'</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">mutation</span><span class="p">.</span><span class="nx">createUser</span><span class="p">(</span>
        <span class="p">{</span> <span class="nx">data</span> <span class="p">},</span>
        <span class="nx">info</span>
      <span class="p">)</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre>
<p>In this section you will start defining the GraphQL schema and define the resolvers.</p>

<p>Start by defining a mutation called <code>signup</code> and a query called <code>user</code>. The first one takes a username and returns an <code>User</code> instance and the second one allows you to retrieve an user given their username.</p>

<p>Next you need to add the code in the resolvers to support signup and user find, open the file <code>src/index.ts</code> and make sure that it looks like the code on the right. There are links to diffs included so you can see exactly what changed. For this tutorial <a href="https://www.prisma.io">Prisma</a> is taking care of the database and ORM setup.</p>

<p>In the mutation signup, you&#39;ll notice that <code>stellarAccount</code> and <code>stellarSeed</code> have a fixed value of <code>1234</code>, that&#39;s just a placeholder. In the next section will add the <code>JS Stellar SDK</code> and use it to generate the account and the seed, also we&#39;ll add a fake service to encrypt the seed before saving it to the database.</p>

<p>You can see all the changes in this section in <a href="https://github.com/abuiles/anchorx-api/pull/3/files">pull request #3</a></p>
<h2 id='assigning-a-stellar-account-to-new-users'>Assigning a Stellar account to new users</h2>
<blockquote>
<p>Install the stellar-sdk and then the TypeScript types for the stellar-sdk</p>
</blockquote>
<pre class="highlight plaintext"><code>yarn add stellar-sdk
yarn add @types/stellar-sdk
</code></pre>
<p>When a user signup the service will generate a Stellar account. First you need to install the <code>JS Stellar SDK</code> and the types definitions for <code>TypeScript</code>.</p>

<p>After installing the SDK, you need to change the signup mutation so it generates a real public key and seed. To do so, the <code>Stellar SDK</code> has a class called <a href="https://stellar.github.io/js-stellar-sdk/Keypair.html">Keypair</a>. You&#39;ll need to import Keypair and then call <code>Keypair.random()</code> to generate a new pair.</p>

<p>On the right you can  see the changes to <code>src/index.ts</code>.</p>
<pre class="highlight javascript tab-javascript"><code> <span class="kr">import</span> <span class="p">{</span> <span class="nx">importSchema</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'graphql-import'</span>
 <span class="kr">import</span> <span class="p">{</span> <span class="nx">Prisma</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./generated/prisma'</span>
 <span class="kr">import</span> <span class="p">{</span> <span class="nx">Context</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./utils'</span>
<span class="o">+</span><span class="kr">import</span> <span class="p">{</span> <span class="nx">Keypair</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

 <span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
   <span class="na">Query</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
   <span class="p">},</span>
   <span class="na">Mutation</span><span class="p">:</span> <span class="p">{</span>
     <span class="nx">signup</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">},</span> <span class="na">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">keypair</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span>
<span class="o">+</span>
       <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
         <span class="nx">username</span><span class="p">,</span>
<span class="o">+</span>        <span class="na">stellarAccount</span><span class="p">:</span> <span class="nx">keypair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">(),</span>
<span class="o">+</span>        <span class="na">stellarSeed</span><span class="p">:</span> <span class="nx">keypair</span><span class="p">.</span><span class="nx">secret</span><span class="p">()</span>
       <span class="p">}</span>

       <span class="p">...</span>
</code></pre>
<p>You should never store seed keys as plain text. In a production app you should probably be using something like Google or AWS KMS and have a clear set of restrictions of who can encrypt or decrypt. In this tutorial you&#39;ll be using an encryption module for Node called <code>crypto-js</code>. In the next section you will add the module and encrypt the seed before saving it.</p>
<h2 id='encrypting-the-seed'>Encrypting the seed</h2>
<blockquote>
<p>Add the crypto-js module with its types.</p>
</blockquote>
<pre class="highlight plaintext"><code>yarn add crypto-js
yarn add @types/crypto-js
</code></pre>
<blockquote>
<p>Use crypto-js before storing the seed key</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code> <span class="kr">import</span> <span class="p">{</span> <span class="nx">Prisma</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./generated/prisma'</span>
 <span class="kr">import</span> <span class="p">{</span> <span class="nx">Context</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'./utils'</span>
 <span class="kr">import</span> <span class="p">{</span> <span class="nx">Keypair</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>
<span class="o">+</span><span class="kr">import</span> <span class="p">{</span> <span class="nx">AES</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'crypto-js'</span>

 <span class="kr">const</span> <span class="nx">resolvers</span> <span class="o">=</span> <span class="p">{</span>
   <span class="na">Query</span><span class="p">:</span> <span class="p">{</span>
     <span class="nx">signup</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">},</span> <span class="na">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
       <span class="kr">const</span> <span class="nx">keypair</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span>

<span class="o">+</span>      <span class="kr">const</span> <span class="nx">configCryptoScret</span> <span class="o">=</span> <span class="s1">'StellarIsAwesome-But-Do-Not-Put-This-Value-In-Code'</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">secret</span> <span class="o">=</span> <span class="nx">AES</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span>
<span class="o">+</span>        <span class="nx">keypair</span><span class="p">.</span><span class="nx">secret</span><span class="p">(),</span>
<span class="o">+</span>        <span class="nx">configCryptoScret</span>
<span class="o">+</span>      <span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
<span class="o">+</span>
       <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
         <span class="nx">username</span><span class="p">,</span>
         <span class="na">stellarAccount</span><span class="p">:</span> <span class="nx">keypair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">(),</span>
<span class="o">-</span>        <span class="na">stellarSeed</span><span class="p">:</span> <span class="nx">keypair</span><span class="p">.</span><span class="nx">secret</span><span class="p">()</span>
<span class="o">+</span>        <span class="na">stellarSeed</span><span class="p">:</span> <span class="nx">secret</span>
       <span class="p">}</span>

       <span class="p">...</span>
</code></pre>
<p>Install <code>crypto-js</code> and after that you can use it in the <code>signup</code> mutation to store the encrypted seed.</p>

<aside class="notice">
For production applications never put any kind of keys in code and use something like Google KMS or AWS KMS to store data securely! You can find a production ready example in StellarGuard. Check the code <a href="https://github.com/stellarguard/stellarguard/blob/master/src/server/lib/utils/crypto.js#L25">here</a>
</aside>

<p>You can see the changes from the previous two sections in <a href="https://github.com/abuiles/anchorx-api/pull/4">pull request #4</a></p>
<h2 id='testing'>Testing</h2><pre class="highlight javascript tab-javascript"><code><span class="nx">mutation</span> <span class="p">{</span>
  <span class="nx">signup</span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="s2">"test"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">id</span><span class="p">,</span>
    <span class="nx">username</span><span class="p">,</span>
    <span class="nx">stellarSeed</span><span class="p">,</span>
    <span class="nx">stellarAccount</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>You can test the changes made up to this point by running the server. To do so type the command <code>yarn dev</code> in your console and it will bring a GraphQL playground to your browser. You can test the <code>signup mutation</code> by pasting the code in the right and hitting run.</p>

<p>AnchorX allows you now to create new users and it assigns a stellar account to each user. However, the Stellar account is not created in the Stellar ledger until it gets funded with some lumens.</p>

<p>The gif below, shows you the process of creating an account and what happens when you try to look at that account on the stellar test network.</p>

<p>The result is a 404 since you never funded the Stellar account.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/0D2x0C3Y3i2C0J2q1i1L/Screen%20Recording%202018-06-28%20at%2011.14%20AM.gif?X-CloudApp-Visitor-Id=49274&amp;v=df174936" alt="Screen%20recording%202018 06 28%20at%2011.14%20am" /></p>

<p>To fix this, AnchorX needs to fund each account with enough lumens to
keep the minimum account balance and then be able to do
transactions. In the next section you will learn how to create account
programatically in Stellar without <code>friendbot</code>.</p>

<aside class="notice">
Lear more about minimum account balance <a href="https://www.stellar.org/developers/guides/concepts/fees.html#minimum-account-balance">here</a>
</aside>
<h2 id='creating-the-account-in-the-stellar-ledger'>Creating the account in the Stellar ledger</h2><pre class="highlight javascript tab-javascript"><code><span class="c1">// Classes required to create new account</span>
<span class="kr">import</span> <span class="p">{</span>
  <span class="nx">Keypair</span><span class="p">,</span> <span class="c1">// Keypair represents public and secret keys.</span>
  <span class="nx">Network</span><span class="p">,</span> <span class="c1">// Network provides helper methods to get the passphrase or id for different stellar networks.</span>
  <span class="nx">Operation</span><span class="p">,</span> <span class="c1">// Operation helps you represent/build operations in Stellar network.</span>
  <span class="nx">Server</span><span class="p">,</span> <span class="c1">// Server handles the network connections.</span>
  <span class="nx">TransactionBuilder</span> <span class="c1">// Helps you construct transactions.</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="c1">// Tell the Stellar SDK you are using the testnet</span>
  <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">();</span>
  <span class="c1">// point to testnet host</span>
  <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">);</span>

  <span class="c1">// Never put values like the an account seed in code.</span>
  <span class="kr">const</span> <span class="nx">provisionerKeyPair</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">fromSecret</span><span class="p">(</span><span class="s1">'SA72TGXRHE26WC5G5MTNURFUFBHZHTIQKF5AQWRXJMJGZUF4XY6HFWJ4'</span><span class="p">)</span>

  <span class="c1">// Load account from Stellar</span>
  <span class="kr">const</span> <span class="nx">provisioner</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">provisionerKeyPair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'creating account in ledger'</span><span class="p">,</span> <span class="nx">keypair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>
  <span class="kr">const</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">provisioner</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
          <span class="c1">// Operation to create new accounts</span>
          <span class="nx">Operation</span><span class="p">.</span><span class="nx">createAccount</span><span class="p">({</span>
            <span class="na">destination</span><span class="p">:</span> <span class="nx">keypair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">(),</span>
            <span class="na">startingBalance</span><span class="p">:</span> <span class="s1">'2'</span>
          <span class="p">})</span>
        <span class="p">).</span><span class="nx">build</span><span class="p">()</span>

  <span class="c1">// Sign the transaction above</span>
  <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">provisionerKeyPair</span><span class="p">)</span>

  <span class="c1">// Submit transaction to the server</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Account created: '</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Stellar account not created.'</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<p>The Stellar SDK includes a transaction builder which helps you create operations. To create an account, you&#39;ll need to use the <a href="https://stellar.github.io/js-stellar-sdk/Operation.html#.createAccount">createAccount operation</a>. The code on the right includes the relevant pieces to create a new account programmatically.</p>

<p>You can follow along and read the comment on what each line represents. After that you&#39;ll need to use that code in the context of the signup mutation to create the account in the Stellar ledger.</p>

<p>You need to extend the signup mutation to fund the user&#39;s account after it has been created successfully.</p>

<p>You can find in <a href="https://github.com/abuiles/anchorx-api/pull/5">pull request #5</a> the change in the mutation using the create account operation.</p>

<aside class="notice">
In a production app, you probably want to have all the code interacting with Stellar accounts and secret keys in a different service like AWS Lambda. Also make use of AWS IAM policies, KMS and force MFA.
</aside>
<h2 id='payments'>Payments</h2><pre class="highlight javascript tab-javascript"><code> <span class="kr">import</span> <span class="p">{</span>
 <span class="o">+</span> <span class="nx">Asset</span><span class="p">,</span>
   <span class="nx">Keypair</span><span class="p">,</span>
 <span class="o">+</span> <span class="nx">Memo</span>
   <span class="nx">Network</span><span class="p">,</span>
   <span class="nx">Operation</span><span class="p">,</span>
   <span class="nx">Server</span><span class="p">,</span>
   <span class="nx">TransactionBuilder</span>
 <span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

 <span class="kr">import</span> <span class="p">{</span>
   <span class="nx">AES</span><span class="p">,</span>
 <span class="o">+</span> <span class="nx">enc</span>
 <span class="p">}</span> <span class="nx">from</span> <span class="s1">'crypto-js'</span><span class="nx">xo</span>

 <span class="kr">const</span> <span class="nx">ENVCryptoSecret</span> <span class="o">=</span> <span class="s1">'StellarIsAwesome-But-Do-Not-Put-This-Value-In-Code'</span>

   <span class="nl">mutations</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span>
<span class="o">+</span>    <span class="nx">async</span> <span class="nx">payment</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">senderUsername</span><span class="p">,</span> <span class="nx">recipientUsername</span><span class="p">,</span> <span class="nx">memo</span> <span class="p">},</span> <span class="nx">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>      <span class="c1">// Load users from database</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">users</span><span class="p">({</span>
<span class="o">+</span>        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
<span class="o">+</span>          <span class="na">username_in</span><span class="p">:</span> <span class="p">[</span><span class="nx">senderUsername</span><span class="p">,</span> <span class="nx">recipientUsername</span><span class="p">]</span>
<span class="o">+</span>        <span class="p">}</span>
<span class="o">+</span>      <span class="p">})</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">sender</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">u</span> <span class="o">=&gt;</span> <span class="nx">u</span><span class="p">.</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">senderUsername</span><span class="p">)</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">recipient</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">u</span> <span class="o">=&gt;</span> <span class="nx">u</span><span class="p">.</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">recipientUsername</span><span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">();</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">);</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="c1">// build the keypair required to sign the payment transaction</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">signerKeys</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">fromSecret</span><span class="p">(</span>
<span class="o">+</span>        <span class="c1">// Use something like KMS in production</span>
<span class="o">+</span>        <span class="nx">AES</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span>
<span class="o">+</span>          <span class="nx">recipient</span><span class="p">.</span><span class="nx">stellarSeed</span><span class="p">,</span>
<span class="o">+</span>          <span class="nx">ENVCryptoSecret</span>
<span class="o">+</span>        <span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="nx">enc</span><span class="p">.</span><span class="nx">Utf8</span><span class="p">)</span>
<span class="o">+</span>      <span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="c1">// Load Stellar account from ledger</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">account</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">sender</span><span class="p">.</span><span class="nx">stellarAccount</span><span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="cm">/*
+        Payments require an asset type, for now users will be sending
+        lumens. In the next chapter you'll create a custom asset
+        representing Dollars and use it.
+      */</span>
<span class="o">+</span>      <span class="kr">const</span> <span class="nx">asset</span> <span class="o">=</span> <span class="nx">Asset</span><span class="p">.</span><span class="kr">native</span><span class="p">()</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="kd">let</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span>
<span class="o">+</span>        <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
<span class="o">+</span>          <span class="nx">Operation</span><span class="p">.</span><span class="nx">payment</span><span class="p">({</span>
<span class="o">+</span>            <span class="na">destination</span><span class="p">:</span> <span class="nx">sender</span><span class="p">.</span><span class="nx">stellarAccount</span><span class="p">,</span>
<span class="o">+</span>            <span class="nx">asset</span><span class="p">,</span>
<span class="o">+</span>            <span class="nx">amount</span>
<span class="o">+</span>          <span class="p">})</span>
<span class="o">+</span>        <span class="p">).</span><span class="nx">build</span><span class="p">()</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">signerKeys</span><span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>      <span class="k">try</span> <span class="p">{</span>
<span class="o">+</span>        <span class="kr">const</span> <span class="p">{</span> <span class="nx">hash</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>        <span class="k">return</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">hash</span> <span class="p">}</span>
<span class="o">+</span>      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`failure </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="o">+</span>
<span class="o">+</span>        <span class="k">throw</span> <span class="nx">e</span>
<span class="o">+</span>      <span class="p">}</span>
<span class="o">+</span>    <span class="p">}</span>
   <span class="p">},</span>
 <span class="p">}</span>
</code></pre>
<p>In Venmo you can send payments using the recipient&#39;s phone number,
email or username. In AnchorX users will be sending money to each
other using their usernames. To keep things simple, you won&#39;t
implement any kind of session management which means you&#39;ll have to
tell the API explicitly who is the sender and the recipient. For
production apps this is very BAD IDEA, but the goal here is not to
build an user management or Authn/Authz system.</p>

<p>To send a payment in Stellar, you need the recipient&#39;s Stellar account
and source account secret.</p>

<p>The code in the right shows the mutation to create new payments. It
takes the sender and recipient username as parameters. It loads first
the user&#39;s data from the database, decrypts the sender seed and then
signs the transaction to submit a payment.</p>

<aside class="notice">
If you are freaking out about decrypting the seed and signing the
transaction with it, don't worry. You will learn more about other ways
to deal with account seeds and signing transactions in a different section.
</aside>

<p>Payments are created using the payment <code>payment</code> function from the
<code>Operation</code> class. You can see it takes the destination, the
asset and the amount.</p>

<p>Since Stellar accounts can hold multiple assets you need to specify
which of the assets held by an account you are trying to transfer. For
now the operation is sending lumens. In AnchorX, users won&#39;t be
sending lumens to each other but the custom asset representing USD.</p>

<p>In the upcoming sections you will:</p>

<ul>
<li>Create a custom asset representing Dollars.</li>
<li>Learn how to allow accounts to hold that asset.</li>
<li>Implement the <code>creditAccount</code> mutation which simulates transferring Dollars from the user bank account to AnchorX.</li>
<li>Change the payment mutation to send USD instead of lumens.</li>
</ul>

<p><a href="https://github.com/abuiles/anchorx-api/pull/7">Pull request #7</a> includes all the changes introduced in this section.</p>
<h2 id='issuing-anchorx-custom-asset'>Issuing AnchorX custom asset</h2>
<p>In this section you&#39;ll learn the high level details of issuing a new asset and how to allow other accounts to hold your asset. Stellar&#39;s official documentation has a great guide about issuing assets so this tutorial won&#39;t repeat the same. You can read more about it here <a href="https://www.stellar.org/developers/guides/issuing-assets.html">https://www.stellar.org/developers/guides/issuing-assets.html</a></p>

<p>To create an asset you&#39;ll need an asset code and an issuing account.</p>

<p>The asset code needs a short identifier, for national currencies you need to use an <a href="https://en.wikipedia.org/wiki/ISO_4217">ISO 4217 code</a>. AnchorX asset will use the code <code>USD</code>.</p>

<p>The issuing account can emit new <code>USD</code>, give it to other accounts and impose some controls around it. In this tutorial the issuing account will be <code>GBX67BEOABQAELIP2XTC6JXHJPASKYCIQNS7WF6GWPSCBEAJEK74HK36</code> with seed <code>SBYZ5NEJ34Y3FTKADVBO3Y76U6VLTREJSW4MXYCVMUBTL2K3V4Y644UX</code>.</p>

<p>Before an account can hold a given asset, it needs to explicitly create
an operation expressing that it trust the asset with code <code>USD</code>
created by the issuing account
<code>GBX67BEOABQAELIP2XTC6JXHJPASKYCIQNS7WF6GWPSCBEAJEK74HK36</code>, such
operation is called creating a <code>trustline</code>.</p>

<p>The issuer can set a condition where it needs to authorize accounts
before they can hold its asset, this is useful if you only want people
who are your clients or have gone through your KYC process to transact
with your asset. In this scenario you need two trustlines one from the customer&#39;s account to your issuing account and then one from your issuing account to the customer&#39;s account.</p>
<h2 id='setting-up-issuing-account'>Setting up issuing account</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="p">{</span>
  <span class="nx">AuthRequiredFlag</span><span class="p">,</span>
  <span class="nx">AuthRevocableFlag</span><span class="p">,</span>
  <span class="nx">Server</span><span class="p">,</span>
  <span class="nx">Keypair</span><span class="p">,</span>
  <span class="nx">Network</span><span class="p">,</span>
  <span class="nx">Operation</span><span class="p">,</span>
  <span class="nx">TransactionBuilder</span><span class="p">,</span>
  <span class="nx">xdr</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">setupIssuer</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">()</span>

  <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">issuerKeyPair</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">fromSecret</span><span class="p">(</span><span class="s1">'SBYZ5NEJ34Y3FTKADVBO3Y76U6VLTREJSW4MXYCVMUBTL2K3V4Y644UX'</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">issuingAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">issuerKeyPair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>

  <span class="kd">var</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">issuingAccount</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
        <span class="nx">Operation</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">({</span>
          <span class="na">setFlags</span><span class="p">:</span> <span class="nx">AuthRevocableFlag</span> <span class="o">|</span> <span class="nx">AuthRequiredFlag</span>
        <span class="p">}))</span>
      <span class="p">.</span><span class="nx">build</span><span class="p">()</span>

  <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">issuerKeyPair</span><span class="p">)</span>
  <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">)</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'All set!'</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">setupIssuer</span><span class="p">()</span>

</code></pre>
<p>The code on the right shows you the basic setup for an account before creating an asset. In it, you are setting the <code>AuthRequiredFlag</code> which requires the trustline from the issuer to the holder and <code>AuthRevocableFlag</code> which allows you to freeze the user&#39;s access to your asset. You can read more about both flags <a href="https://www.stellar.org/developers/guides/concepts/assets.html#controlling-asset-holders">here</a>. Since this is something which is done once, this is not included in the GitHub repo. You can try it in <a href="https://repl.it/@abuiles/SetupAnchorFlags">Repl.it</a></p>

<p>Next you need to extend the signup mutation to create both trustlines when an user creates a new account.</p>
<h2 id='creating-a-trustline'>Creating a trustline</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">import</span> <span class="p">{</span>
  <span class="nx">Asset</span><span class="p">,</span>
  <span class="nx">Keypair</span><span class="p">,</span>
  <span class="nx">Network</span><span class="p">,</span>
  <span class="nx">Operation</span><span class="p">,</span>
  <span class="nx">Server</span><span class="p">,</span>
  <span class="nx">TransactionBuilder</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">'stellar-sdk'</span>

<span class="kr">export</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">createTrustline</span><span class="p">(</span><span class="nx">accountKeypair</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">);</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">account</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">accountKeypair</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>
    <span class="kr">const</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
        <span class="nx">Operation</span><span class="p">.</span><span class="nx">changeTrust</span><span class="p">({</span>
          <span class="na">asset</span><span class="p">:</span> <span class="nx">AnchorXUSD</span>
        <span class="p">}))</span>
      <span class="p">.</span><span class="nx">build</span><span class="p">();</span>

    <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">accountKeypair</span><span class="p">)</span>

    <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">)</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'trustline created from  account to issuer and signers updated'</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">result</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'create trustline failed.'</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>The code on the right shows you how to create a trustline from an account to the issuer account. You&#39;ll be using that function inside the signup mutation.</p>

<p>Now after you create a new user, you will also create a trustline from the new account to AnchorX asset. You are not done yet, although the account accepts AnchorX <code>USD</code>, if you try to send <code>USD</code> to that account it won&#39;t work because the account hasn&#39;t been authorized to hold the asset.</p>

<p>After a trustline is created, you&#39;ll see the custom asset in the account&#39;s balance.</p>

<p>The following gif shows you an account&#39;s state after it gets created without the trustline to AnchorX asset. You can see that the balance key only shows native.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/113r1e353x3S1s1V2k2I/Screen%20Recording%202018-07-09%20at%2002.56%20PM.gif?X-CloudApp-Visitor-Id=49274&amp;v=559df5f9" alt="Screen%20recording%202018 07 09%20at%2002.56%20pm" /></p>

<p>And the next one will show you what happens in the account after creating the trustline.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/0r2R1z2h2g2p2t3L3O0m/Screen%20Recording%202018-07-09%20at%2003.00%20PM.gif?X-CloudApp-Visitor-Id=49274&amp;v=a19639ff" alt="Screen%20recording%202018 07 09%20at%2003.00%20pm" /></p>

<p>You can see the changes from this section in <a href="https://github.com/abuiles/anchorx-api/pull/8">pull request #8</a>.</p>
<h2 id='allow-trustline'>Allow trustline</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">export</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">allowTrust</span><span class="p">(</span><span class="nx">trustor</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">);</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// Never store secrets in code! Use something like KMS and put</span>
    <span class="c1">// this somewhere were few people can access it.</span>
    <span class="kr">const</span> <span class="nx">issuingKeys</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">fromSecret</span><span class="p">(</span><span class="s1">'SBYZ5NEJ34Y3FTKADVBO3Y76U6VLTREJSW4MXYCVMUBTL2K3V4Y644UX'</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">issuingAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">issuingKeys</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>

    <span class="kr">const</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">issuingAccount</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
        <span class="nx">Operation</span><span class="p">.</span><span class="nx">allowTrust</span><span class="p">({</span>
          <span class="nx">trustor</span><span class="p">,</span>
          <span class="na">assetCode</span><span class="p">:</span> <span class="nx">AnchorXUSD</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span>
          <span class="na">authorize</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">})</span>
      <span class="p">)</span>
      <span class="p">.</span><span class="nx">build</span><span class="p">();</span>

    <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">issuingKeys</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">)</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'trust allowed'</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">result</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'allow trust failed'</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>On the right you can see the allow trust operation in used. It
receives the public key of the account that you want to authorize and
the asset&#39;s code.</p>

<p>Now you can use that function after calling <code>createTrustline</code>. <a href="https://github.com/abuiles/anchorx-api/pull/9/files">Pull request #9</a> shows you how to use the <code>allowTrust</code> function inside the signup mutation.</p>
<h2 id='welcome-balance'>Welcome balance</h2><pre class="highlight javascript tab-javascript"><code><span class="kr">export</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">payment</span><span class="p">(</span><span class="nx">signerKeys</span><span class="p">:</span> <span class="nx">Keypair</span><span class="p">,</span> <span class="nx">destination</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">amount</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Network</span><span class="p">.</span><span class="nx">useTestNetwork</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">stellarServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="s1">'https://horizon-testnet.stellar.org'</span><span class="p">);</span>

  <span class="kr">const</span> <span class="nx">account</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">loadAccount</span><span class="p">(</span><span class="nx">signerKeys</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">())</span>

  <span class="kd">let</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TransactionBuilder</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">addOperation</span><span class="p">(</span>
      <span class="nx">Operation</span><span class="p">.</span><span class="nx">payment</span><span class="p">({</span>
        <span class="nx">destination</span><span class="p">,</span>
        <span class="na">asset</span><span class="p">:</span> <span class="nx">AnchorXUSD</span><span class="p">,</span>
        <span class="nx">amount</span>
      <span class="p">})</span>
    <span class="p">).</span><span class="nx">addMemo</span><span class="p">(</span><span class="nx">Memo</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">'https://goo.gl/6pDRPi'</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">build</span><span class="p">()</span>

  <span class="nx">transaction</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">signerKeys</span><span class="p">)</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">hash</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">stellarServer</span><span class="p">.</span><span class="nx">submitTransaction</span><span class="p">(</span><span class="nx">transaction</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">hash</span> <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`failure </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
    <span class="k">throw</span> <span class="nx">e</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>In theory, AnchorX and the Stellar accounts it creates are ready to
receive and send <code>USD</code>. AnchorX&#39;s growth hackers have decided that the
best way to bring people to the platform is by giving each user a
welcome bonus of $10 USD.</p>

<p>You need to extend the signup mutation to send new users $10 USD. Add the function on the right to utils and then call it after the allow trustline operation.</p>

<p>The function takes the signer keys, that is the account we are debiting the USD from, the destination is the account to be credited and instead of sending the native asset, you are sending the custom USD.</p>

<p>You can use now that function inside the signup mutation with the issuing keypair.</p>

<p>The following gif show you how after creating new accounts, they end up with $10 USD in their balance.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/0n1c1o2o0F2P2H0c3K1b/Screen%20Recording%202018-07-09%20at%2004.41%20PM.gif?X-CloudApp-Visitor-Id=49274&amp;v=c08071af" alt="Screen%20recording%202018 07 09%20at%2004.41%20pm" /></p>

<p><a href="https://github.com/abuiles/anchorx-api/pull/10">Pull request #10</a>
includes all the changes introduced in this section. Now that AnchorX
users can hold USD, let&#39;s replace the payment mutation to send USD and
also give them a way to debit or credit their accounts.</p>
<h2 id='paying-with-usd'>Paying with USD</h2><pre class="highlight javascript tab-javascript"><code>    <span class="nx">async</span> <span class="nx">payment</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">senderUsername</span><span class="p">,</span> <span class="nx">recipientUsername</span><span class="p">,</span> <span class="nx">memo</span> <span class="p">},</span> <span class="nx">context</span><span class="p">:</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">users</span><span class="p">({</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">username_in</span><span class="p">:</span> <span class="p">[</span><span class="nx">senderUsername</span><span class="p">,</span> <span class="nx">recipientUsername</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">})</span>

      <span class="kr">const</span> <span class="nx">sender</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">u</span> <span class="o">=&gt;</span> <span class="nx">u</span><span class="p">.</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">senderUsername</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">recipient</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">u</span> <span class="o">=&gt;</span> <span class="nx">u</span><span class="p">.</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">recipientUsername</span><span class="p">)</span>

      <span class="kr">const</span> <span class="nx">signerKeys</span> <span class="o">=</span> <span class="nx">Keypair</span><span class="p">.</span><span class="nx">fromSecret</span><span class="p">(</span>
        <span class="c1">// Use something like KMS in production</span>
        <span class="nx">AES</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span>
          <span class="nx">sender</span><span class="p">.</span><span class="nx">stellarSeed</span><span class="p">,</span>
          <span class="nx">ENVCryptoSecret</span>
        <span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="nx">enc</span><span class="p">.</span><span class="nx">Utf8</span><span class="p">)</span>
      <span class="p">)</span>

      <span class="k">try</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="p">{</span> <span class="nx">hash</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">payment</span><span class="p">(</span>
          <span class="nx">signerKeys</span><span class="p">,</span>
          <span class="nx">recipient</span><span class="p">.</span><span class="nx">stellarAccount</span><span class="p">,</span>
          <span class="nx">amount</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">hash</span> <span class="p">}</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`failure </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>

        <span class="k">throw</span> <span class="nx">e</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre>
<p>You already have a payment mutation to allow people to send money between each other. Until now it was sending the native asset but since users can hold USD you need to replace it to send USD. To do so, you can use the payment function from the previous section.</p>

<p>The code on the right shows you the new version of the payment mutation, which uses the <code>payment</code> function.</p>

<p>The following gif show you the payment mutation in action.</p>

<p><img src="https://d3vv6lp55qjaqc.cloudfront.net/items/2m06171D3o3x1O2p3c3Z/Screen%20Recording%202018-07-09%20at%2005.06%20PM.gif?X-CloudApp-Visitor-Id=49274&amp;v=e39af9cd" alt="Screen%20recording%202018 07 09%20at%2005.06%20pm" /></p>

<p>[Pull request #11[(https://github.com/abuiles/anchorx-api/pull/11) shows you the changes introduced in this section.</p>
<h2 id='credit-account'>Credit account</h2>
<p>API end-point to &quot;transfer&quot; USD from bank account to Stellar account.</p>
<h2 id='debit-account'>Debit account</h2>
<p>API end-point to transfer money from AnchorX to bank account.</p>
<h1 id='building-the-mobile-wallet'>Building the mobile wallet</h1><h2 id='using-the-stellar-sdk-in-react-native'>Using the Stellar-SDK in React-Native</h2>
<p>Introduce the Stellar-SDK polyfill and how to display an account data in a RN app.</p>
<h2 id='creating-an-user-signup-flow'>Creating an user signup flow</h2>
<p>Very simple user signup flow based in user name. It shows how to setup Stellar account, multisig and trustline schema.</p>
<h2 id='depositing-quot-fiat-quot-into-your-wallet'>Depositing &quot;fiat&quot; into your wallet</h2>
<p>A fake implementation in the wallet similar to transferring money from a bank.</p>
<h2 id='showing-account-transactions'>Showing account transactions</h2>
<p>Implements the transaction history in the RN wallet.</p>
<h2 id='sending-payments'>Sending payments</h2>
<p>Flow for doing P2P payments.</p>
<h2 id='cashing-out'>Cashing out</h2>
<p>Fake implementation for transferring money to the bank accountp</p>
<h1 id='security'>Security</h1>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
<h2 id='infrastructure'>Infrastructure</h2><h2 id='keeping-keys-secure'>Keeping keys secure</h2><h1 id='f-a-q'>F.A.Q</h1>
<aside class="notice">
This error section is stored in a separate file in <code>includes/_errors.md</code>. Slate allows you to optionally separate out your docs into many files...just save them to the <code>includes</code> folder and add them to the top of your <code>index.md</code>'s frontmatter. Files are included in the order listed.
</aside>

<p>The Kittn API uses the following error codes:</p>

<table><thead>
<tr>
<th>Error Code</th>
<th>Meaning</th>
</tr>
</thead><tbody>
<tr>
<td>400</td>
<td>Bad Request -- Your request is invalid.</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized -- Your API key is wrong.</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden -- The kitten requested is hidden for administrators only.</td>
</tr>
<tr>
<td>404</td>
<td>Not Found -- The specified kitten could not be found.</td>
</tr>
<tr>
<td>405</td>
<td>Method Not Allowed -- You tried to access a kitten with an invalid method.</td>
</tr>
<tr>
<td>406</td>
<td>Not Acceptable -- You requested a format that isn&#39;t json.</td>
</tr>
<tr>
<td>410</td>
<td>Gone -- The kitten requested has been removed from our servers.</td>
</tr>
<tr>
<td>418</td>
<td>I&#39;m a teapot.</td>
</tr>
<tr>
<td>429</td>
<td>Too Many Requests -- You&#39;re requesting too many kittens! Slow down!</td>
</tr>
<tr>
<td>500</td>
<td>Internal Server Error -- We had a problem with our server. Try again later.</td>
</tr>
<tr>
<td>503</td>
<td>Service Unavailable -- We&#39;re temporarily offline for maintenance. Please try again later.</td>
</tr>
</tbody></table>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="javascript">javascript</a>
          </div>
      </div>
    </div>
  </body>
</html>
